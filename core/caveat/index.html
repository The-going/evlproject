<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.88.1" />
    <meta name="description" content="Xenomai 4 project">
    <meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">
    <link rel="icon" href="https://the-going.github.io/evlproject/images/favicon.png" type="image/png">
    <title>Things you definitely want to know :: Xenomai 4</title>
    <link href="https://the-going.github.io/evlproject/css/nucleus.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/fontawesome-all.min.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/featherlight.min.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/perfect-scrollbar.min.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/auto-complete.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/theme.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/theme-evl.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/variant.css?1634415568" rel="stylesheet">
    <link href="https://the-going.github.io/evlproject/css/print.css?1634415568" rel="stylesheet" media="print">
    <script src="https://the-going.github.io/evlproject/js/jquery.min.js?1634415568"></script>
    <style>
      :root #header + #content > #left > #rlblock_left{
        display:none !important;
      }
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
    </style>
  </head>
  <body class="" data-url="https://the-going.github.io/evlproject/core/caveat/">
    <nav id="sidebar" class="showVisitedLinks">
      <div id="header-wrapper">
        <div id="header">
<a href="https://the-going.github.io/evlproject/"><img src="https://the-going.github.io/evlproject/images/xenomai-logo.png"></a>

        </div>
        <div class="searchbox">
          <label for="search-by"><i class="fas fa-search"></i></label>
          <input data-search-input id="search-by" type="search" placeholder="Search...">
          <span data-search-clear=""><i class="fas fa-times"></i></span>
        </div>
        <script src="https://the-going.github.io/evlproject/js/lunr.min.js?1634415568"></script>
        <script src="https://the-going.github.io/evlproject/js/auto-complete.js?1634415568"></script>
        <!-- hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic: -->
        <!-- https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72 -->
        <script>
          var index_url="https://the-going.github.io/evlproject/index.json";
          var root_url="https://the-going.github.io/evlproject/";
          var baseUri=root_url.replace(/\/$/, '');
        </script>
        <script src="https://the-going.github.io/evlproject/js/search.js?1634415568"></script>
      </div>
      <div class="highlightable">
        <ul class="topics">
          <li data-nav-id="/overview/" title="Overview" class="dd-item"><a href="https://the-going.github.io/evlproject/overview/">&#8226; Get Started<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/" title="The EVL core" class="dd-item parent"><a href="https://the-going.github.io/evlproject/core/">&#8226; Real-time core<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/core/build-steps/" title="Building EVL" class="dd-item"><a href="https://the-going.github.io/evlproject/core/build-steps/">Building EVL<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/runtime-settings/" title="Runtime configuration" class="dd-item"><a href="https://the-going.github.io/evlproject/core/runtime-settings/">Runtime settings<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/testing/" title="Testing the installation" class="dd-item"><a href="https://the-going.github.io/evlproject/core/testing/">Running tests<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/commands/" title="The &#39;evl&#39; command" class="dd-item"><a href="https://the-going.github.io/evlproject/core/commands/">Commands<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/benchmarks/" title="Running benchmarks" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/benchmarks/">Benchmarking<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/caveat/" title="Things you definitely want to know" class="dd-item active"><a href="https://the-going.github.io/evlproject/core/caveat/">Caveat<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/user-api/" title="Using libevl" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/">&#9702; Application interface<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/core/user-api/function_index/" title="libevl function index" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/function_index/">Function index<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/mutex/" title="Mutex" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/mutex/">Mutex<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/semaphore/" title="Semaphore" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/semaphore/">Semaphore<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/observable/" title="Observable" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/observable/">Observable<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/proxy/" title="File proxy" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/proxy/">File proxy<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/poll/" title="Polling file descriptors" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/poll/">Polling file descriptors<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/io/" title="Out-of-band I/O services" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/io/">Out-of-band I/O services<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/misc/" title="Miscellanea" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/user-api/misc/">Misc. services<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/user-api/api-revs/" title="API revisions" class="dd-item"><a href="https://the-going.github.io/evlproject/core/user-api/api-revs/">API revisions<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/core/oob-drivers/" title="Real-time I/O drivers" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/oob-drivers/">&#9702; Real-time I/O drivers<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/core/oob-drivers/dma/" title="DMA" class="dd-item"><a href="https://the-going.github.io/evlproject/core/oob-drivers/dma/">DMA<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/oob-drivers/spi/" title="SPI" class="dd-item"><a href="https://the-going.github.io/evlproject/core/oob-drivers/spi/">SPI<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/core/oob-drivers/gpio/" title="GPIO" class="dd-item"><a href="https://the-going.github.io/evlproject/core/oob-drivers/gpio/">GPIO<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/core/kernel-api/" title="Writing drivers" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/">&#9702; Writing drivers<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/core/kernel-api/function_index/" title="Kernel function index" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/function_index/">Function index<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/file/" title="File description" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/file/">File description<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/socket/" title="Socket interface" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/socket/">Socket interface<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/kthread/" title="Kernel thread" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/kthread/">Kernel thread<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/wait/" title="Wait queue" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/wait/">Wait queue<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/mutex/" title="Kernel mutex" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/mutex/">Kernel mutex<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/semaphore/" title="Kernel semaphore" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/semaphore/">Kernel semaphore<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/flag/" title="Kernel flag" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/flag/">Kernel flag<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/spinlock/" title="EVL Spinlock" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/spinlock/">EVL Spinlock<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/timer/" title="Timer" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/timer/">Timer<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/xbuf/" title="Cross-buffer access" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/xbuf/">Cross-buffer access<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/interrupts/" title="Managing IRQs" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/interrupts/">Managing IRQs<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/core/kernel-api/stax/" title="Stage exclusion lock" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/kernel-api/stax/">Stage exclusion lock<i class="fas fa-check read-icon"></i></a><ul></ul></li></ul></li>
          <li data-nav-id="/core/under-the-hood/" title="Under the hood" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/core/under-the-hood/">&#9702; Under the hood<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/core/under-the-hood/abi/" title="The EVL ABI" class="dd-item"><a href="https://the-going.github.io/evlproject/core/under-the-hood/abi/">ABI revisions<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/core/abi-revs/" title="ABI revisions" class="dd-item"><a href="https://the-going.github.io/evlproject/core/abi-revs/">ABI revisions<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/dovetail/" title="Dovetail interface" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/">&#8226; Dovetail interface<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/dovetail/pipeline/" title="Interrupt pipeline" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/">&#9702; Interrupt pipeline<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/dovetail/pipeline/irq_handling/" title="IRQ handling" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/irq_handling/">IRQ handling<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/synthetic/" title="Synthetic IRQs" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/synthetic/">Synthetic IRQs<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/pipeline_inject/" title="IRQ injection" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/pipeline_inject/">IRQ injection<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/interrupt_protection/" title="Interrupt protection" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/interrupt_protection/">Interrupt protection<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/stage_push/" title="Installing the out-of-band stage" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/stage_push/">OOB stage installation<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/stage_escalation/" title="Stage escalation" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/stage_escalation/">Stage escalation<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/pipeline/locking/" title="Locking" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/pipeline/locking/">Locking<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/dovetail/porting/" title="Porting Dovetail" class="dd-item alwaysopen"><a href="https://the-going.github.io/evlproject/dovetail/porting/">&#9702; Porting Dovetail<i class="fas fa-check read-icon"></i></a><ul>
          <li data-nav-id="/dovetail/porting/prerequisites/" title="Prerequisites" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/prerequisites/">Prerequisites<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/irqflow/" title="Interrupt flow" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/irqflow/">Interrupt flow<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/atomic/" title="Atomic operations" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/atomic/">Atomic operations<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/arch/" title="Architecture-specific bits" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/arch/">Architecture bits<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/timer/" title="Tick devices" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/timer/">Tick devices<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/clocksource/" title="Reading clock sources" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/clocksource/">Clock sources<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/syscall/" title="Syscall path" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/syscall/">Syscall path<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/rawprintk/" title="Raw printk support" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/rawprintk/">Serial debugging<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/misc/" title="Misc" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/misc/">Misc<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/porting/devnotes/">Developer&#39;s Notes<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/dovetail/altsched/" title="Alternate scheduling" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/altsched/">Alternate scheduling<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/files/" title="File tracking" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/files/">File tracking<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/sockets/" title="Socket handling" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/sockets/">Socket handling<i class="fas fa-check read-icon"></i></a></li>
          <li data-nav-id="/dovetail/rulesofthumb/" title="Rules Of Thumb" class="dd-item"><a href="https://the-going.github.io/evlproject/dovetail/rulesofthumb/">Rules Of Thumb<i class="fas fa-check read-icon"></i></a></li></ul></li>
          <li data-nav-id="/ports/" title="Status of EVL ports" class="dd-item"><a href="https://the-going.github.io/evlproject/ports/">&#8226; Ports<i class="fas fa-check read-icon"></i></a><ul></ul></li>
          <li data-nav-id="/contributing/" title="Contributing to Xenomai 4" class="dd-item"><a href="https://the-going.github.io/evlproject/contributing/">&#8226; Contributing<i class="fas fa-check read-icon"></i></a><ul></ul></li>
        </ul>
        <div id="shortcuts">
          <div class="nav-title"></div>
          <ul>
            <li><a class="padding" href="https://the-going.github.io/evlproject/"><i class='fas fa-home'></i> Home</a></li>
            <li><a class="padding" href="https://riot.im/app/#/room/#evlproject:matrix.org/"><i class='fas fa-comments'></i> RIOT channel</a></li>
            <li><a class="padding" href="https://xenomai.org/mailman/listinfo/xenomai/"><i class='fas fa-comment-dots'></i> Mailing list</a></li>
          </ul>
        </div>
        <div id="prefooter">
          <hr/>
          <ul>
            <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
          </ul>
        </div>
        <div id="footer">

        </div>
      </div>
    </nav>
    <div id="body">
      <div id="overlay"></div>
      <div class="padding highlightable">
        <div id="top-bar">
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                <i class="fas fa-bars"></i>
              </a>
            </span>
            <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <meta itemprop="itemListOrder" content="Descending" />
                <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="3" /><a itemprop="item" href="https://the-going.github.io/evlproject/"><span itemprop="name">Xenomai 4</span></a> > </li>
                <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="2" /><a itemprop="item" href="https://the-going.github.io/evlproject/core/"><span itemprop="name">The EVL core</span></a> > </li>
                <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="1" /><a itemprop="item" href="https://the-going.github.io/evlproject/core/caveat/" aria-disabled="true"><span itemprop="name">Things you definitely want to know</span></a></li>
            </ol>
          </div>
            <div class="progress">
              <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#generic-issues">Generic issues</a>
      <ul>
        <li><a href="#caveat-isocpus"><code>isolcpus</code> is our friend too</a></li>
        <li><a href="#config_debug_hard_locks-is-cool-but-ruins-real-time-guarantees"><code>CONFIG_DEBUG_HARD_LOCKS</code> is cool but ruins real-time guarantees</a></li>
        <li><a href="#caveat-cpufreq">CPU frequency scaling (usually) has a negative impact on latency</a></li>
        <li><a href="#disable-config_smp-for-best-latency-on-single-core-systems">Disable <code>CONFIG_SMP</code> for best latency on single-core systems</a></li>
      </ul>
    </li>
    <li><a href="#architecture-specific-issues">Architecture-specific issues</a>
      <ul>
        <li><a href="#x86-caveat">x86</a></li>
      </ul>
    </li>
  </ul>
</nav>
              </div>
            </div>
        </div>
        <div id="head-tags">
        </div>
        <main id="body-inner">
          <h1>Things you definitely want to know</h1>

<h2 id="generic-issues">Generic issues</h2>
<h3 id="caveat-isocpus"><code>isolcpus</code> is our friend too</h3>
<p>Isolating some CPUs on the kernel command line using the <em>isolcpus=</em>
option, in order to prevent the load balancer from offloading in-band
work to them is not only a good idea with
<a href="https://wiki.linuxfoundation.org/realtime/rtl/blog">PREEMPT_RT</a>, but
for any dual kernel configuration too.</p>
<p>By doing so, having some random in-band work evicting cache lines on a
CPU where real-time threads briefly sleep is less likely, increasing
the odds of costly cache misses, which translates positively into the
latency numbers you can get. Even if EVL&rsquo;s small footprint core has a
limited exposure to such kind of disturbance, saving a handful of
microseconds is worth it when the worst case figure is already within
tenths of microseconds.</p>
<h3 id="config_debug_hard_locks-is-cool-but-ruins-real-time-guarantees"><code>CONFIG_DEBUG_HARD_LOCKS</code> is cool but ruins real-time guarantees</h3>
<p>When <code>CONFIG_DEBUG_HARD_LOCKS</code> is enabled, the lock dependency engine
(<code>CONFIG_LOCKDEP</code>) which helps in tracking down deadlocks and other
locking-related issues is also enabled for Dovetail&rsquo;s <a href="https://the-going.github.io/evlproject/dovetail/pipeline/locking/#new-spinlocks">hard
locks</a>,
which underpins most of the serialization mechanisms the EVL core
uses.</p>
<p>This is nice as it has the lock validator monitor the hard spinlocks
EVL uses too. However, this comes with a high price latency-wise:
seeing hundreds of microseconds spent in the validator with hard
interrupts off from time to time is not uncommon. Running the latency
monitoring utility (aka <code>latmus</code>) which is part of <code>libevl</code> in this
configuration should give you pretty ugly numbers.</p>
<p>In short, it is fine enabling <code>CONFIG_DEBUG_HARD_LOCKS</code> for debugging
some locking pattern in EVL, but you won&rsquo;t be able to meet real-time
requirements at the same time in such configuration.</p>
<h3 id="caveat-cpufreq">CPU frequency scaling (usually) has a negative impact on latency</h3>
<p>Enabling the <em>ondemand</em> CPUFreq governor - or any governor performing
dynamic adjustment of the CPU frequency - may induce significant
latency for EVL on your system, from ten microseconds to more than a
hundred depending on the hardware. Selecting the so-called
<em>performance</em> governor is the safe option, which guarantees that no
frequency transition ever happens, keeping the CPUs at their maximum
processing speed.</p>
<p>In other words, if <code>CONFIG_CPU_FREQ</code> has to be enabled in your
configuration, enabling <code>CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE</code> and
<code>CONFIG_CPU_FREQ_GOV_PERFORMANCE</code> exclusively is most often the best way
to prevent unexpectedly high latency peaks.</p>
<h3 id="disable-config_smp-for-best-latency-on-single-core-systems">Disable <code>CONFIG_SMP</code> for best latency on single-core systems</h3>
<p>On single-core hardware, some out-of-line code may still be executed
for dealing with various types of spinlock with a SMP build, which
translates into additional CPU branches and cache misses. On low end
hardware, this overhead may be noticeable.</p>
<p>Therefore, if you neither need SMP support nor kernel debug options
which depend on instrumenting the spinlock constructs (e.g.
<code>CONFIG_DEBUG_PREEMPT</code>), you may want to disable all the related kernel
options, starting with <code>CONFIG_SMP</code>.</p>
<h2 id="architecture-specific-issues">Architecture-specific issues</h2>
<h3 id="x86-caveat">x86</h3>
<ul>
<li>
<p>GCC 10.x might generate code causing the SMP boot process to break
early, as reported <a href="https://lkml.org/lkml/2020/3/14/186">by this
post</a>. As a work-around, you
can disable <code>CONFIG_STACKPROTECTOR_STRONG</code> from your kernel
configuration.</p>
</li>
<li>
<p><code>CONFIG_ACPI_PROCESSOR_IDLE</code> may increase the latency upon wakeup on
IRQ from idle on some SoC (up to 30 us observed) on x86. This option
is implicitly selected by the following configuration chain:
<code>CONFIG_SCHED_MC_PRIO</code> → <code>CONFIG_INTEL_PSTATE</code> →
<code>CONFIG_ACPI_PROCESSOR</code>. If out-of-range latency figures are observed
on your x86 hardware, turning off this chain may help.</p>
</li>
<li>
<p>When the HPET is disabled, the watchdog which monitors the sanity of
the current clocksource for the kernel may use <em>refined-jiffies</em> as
the reference clocksource to compare with. Unfortunately, such
clocksource is fairly imprecise for timekeeping since timer
interrupts might be missed.  This could in turn trigger false
positives with the watchdog, which would end up declaring the TSC
clocksource as &lsquo;unstable&rsquo;. For instance, it has been observed that
enabling  <code>CONFIG_FUNCTION_GRAPH_TRACER</code> on some legacy hardware would
systematically cause such behavior at boot. The following warning
splat appearing in the kernel log is symptomatic of this problem:</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">clocksource: timekeeping watchdog on CPU0: Marking clocksource
             &#39;tsc-early&#39; as unstable because the skew is too large:
clocksource: &#39;refined-jiffies&#39; wd_now: fffb7018 wd_last: fffb6e9d 
             mask: ffffffff
clocksource: &#39;tsc-early&#39; cs_now: 68a6a7070f6a0 cs_last: 68a69ab6f74d6 
             mask: ffffffffffffffff
tsc: Marking TSC unstable due to clocksource watchdog
</code></pre></div><p>This is a problem because the TSC is the best-rated
clocksource and <a href="https://the-going.github.io/evlproject/dovetail/porting/clocksource/#time-vdso-access">directly accessible from the vDSO</a>, which speeds
up timestamping operations. If the TSC on your hardware is known to be
fine and face this issue nevertheless, you may want to pass
<code>tsc=nowatchdog</code> to the kernel to prevent it, or even <code>tsc=reliable</code>
if all TSCs are reliable enough to be synchronized across CPUs.  If
the TSC is really unstable on some legacy hardware and you cannot
ignore the watchdog alert, you can still leave it to other
clocksources such as <em>acpi_pm</em>. Calls to <a href="https://the-going.github.io/evlproject/core/user-api/clock/#evl_read_clock">evl_read_clock()</a> would be
slower compared to a direct syscall-less readout from the vDSO, but
the EVL core would nevertheless manage to get timestamps from its
<a href="https://the-going.github.io/evlproject/core/user-api/clock/#builtin-clocks">built-in clocks</a> at the expense of
an out-of-band system call, without involving the in-band stage
though. You definitely want to make sure everything is right on your
platform with respect to reading timestamps by running the
<a href="https://the-going.github.io/evlproject/core/testing/#latmus-program">latmus</a> test, which
can detect any related issue.</p>
<p>You can retrieve the current clocksource used by the kernel as follows:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#78787e"># cat /sys/devices/system/clocksource/clocksource0/current_clocksource</span>
tsc
</code></pre></div><ul>
<li>NMI-based <em>perf</em> data collection may cause the kernel to execute
utterly sluggish ACPI driver code at each event. Since disabling
<code>CONFIG_PERF</code> is not an option, passing <code>nmi_watchodg=0</code> on the
kernel command line at boot may help.</li>
</ul>

<div class="notices warning">
    <div class="label">Warning</div><p>Passing <code>nmi_watchodg=0</code> turns off the hard lockup detection for the
in-band kernel. However, EVL will still detect runaway EVL threads
stuck in out-of-band execution if <code>CONFIG_EVL_WATCHDOG</code> is enabled.</p>

</div>
<hr>
<p style="text-align:right">Last modified: Sat, 16 Oct 2021 23:13:14 MSK</p>


          <footer class="footline">
          </footer>
        </main>
      </div>
      <div id="navigation">
        <a class="nav nav-prev" href="https://the-going.github.io/evlproject/core/benchmarks/" title="Running benchmarks"><i class="fa fa-chevron-left"></i></a>
        <a class="nav nav-next" href="https://the-going.github.io/evlproject/core/user-api/" title="Using libevl"><i class="fa fa-chevron-right"></i></a>
      </div>
    </div>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://the-going.github.io/evlproject/js/clipboard.min.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/perfect-scrollbar.min.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/perfect-scrollbar.jquery.min.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/jquery.svg.pan.zoom.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/featherlight.min.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/modernizr.custom-3.6.0.js?1634415568"></script>
    <script src="https://the-going.github.io/evlproject/js/mermaid.min.js?1634415568"></script>
    <script>
      if (typeof mermaid != 'undefined') {
        mermaid.mermaidAPI.initialize( Object.assign( { "securityLevel": "antiscript" }, JSON.parse("{ \"startOnLoad\": true }"), { startOnLoad: false } ) );
      }
    </script>
    <script src="https://the-going.github.io/evlproject/js/relearn.js?1634415568"></script>
  </body>
</html>
