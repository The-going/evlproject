<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.37.1" />
    <meta name="description" content="Evenless co-kernel">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Alternate scheduling :: Evenless core documentation</title>

    
    <link href="/css/nucleus.css?1553763591" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1553763591" rel="stylesheet">
    <link href="/css/hybrid.css?1553763591" rel="stylesheet">
    <link href="/css/featherlight.min.css?1553763591" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1553763591" rel="stylesheet">
    <link href="/css/auto-complete.css?1553763591" rel="stylesheet">
    <link href="/css/theme.css?1553763591" rel="stylesheet">
    <link href="/css/hugo-theme.css?1553763591" rel="stylesheet">
    
      <link href="/css/theme-evl.css?1553763591" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1553763591"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/dovetail/altsched/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/evl-silver.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1553763591"></script>
<script type="text/javascript" src="/js/auto-complete.js?1553763591"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/evenless.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1553763591"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/dovetail/" title="Dovetail interface" class="dd-item 
        parent
        
        
        ">
      <a href="/dovetail/">
          &#9656; Dovetail interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/" title="Interrupt pipeline" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/">
          &rsaquo; Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/optimistic/">
        &rsaquo; Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/porting/" title="Porting" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/porting/">
          &rsaquo; Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/dovetail/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/dovetail/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/dovetail/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/dovetail/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/dovetail/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item ">
        <a href="/dovetail/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/dovetail/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item ">
        <a href="/dovetail/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/usage/" title="Kernel API" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/usage/">
          &rsaquo; Kernel API
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_push/" title="Installing the out-of-band stage" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_push/">
        OOB stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/dovetail/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/dovetail/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/dovetail/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/altsched/" title="Alternate scheduling" class="dd-item 
        parent
        active
        
        ">
      <a href="/dovetail/altsched/">
          &rsaquo; Alternate scheduling
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/dovetail/rulesofthumb/">
        &rsaquo; Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/core/" title="The EVL core" class="dd-item 
        
        
        
        ">
      <a href="/core/">
          &#9656; Real-time core
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/" title="The EVL library" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/">
          &rsaquo; Application interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/thread/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/thread/">
          Thread
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/mutex/" title="Mutex" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/mutex/">
          Mutex
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/condvar/" title="Condition variable" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/condvar/">
          Condition variable
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/semaphore/" title="Counting semaphore" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/semaphore/">
          Counting semaphore
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/clock/" title="Clock element" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/clock/">
          Clocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/timer/">
          Timer(fd)
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/xbuf/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/xbuf/">
          Cross-buffer
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/proxy/" title="File proxy" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/proxy/">
          File proxy
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/poll/" title="Polling file descriptors" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/poll/">
          Polling file descriptors
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/io/" title="Out-of-band I/O services" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/io/">
          Out-of-band I/O
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/scheduling/" title="Scheduling policies" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/scheduling/">
          Scheduling policies
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/utils/" title="Utilities" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/utils/">
          Utilities
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/" title="Driver interface" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/">
          &rsaquo; Driver interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/file/" title="File description" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/file/">
          File description
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/kthread/" title="Kernel threads" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/kthread/">
          Kernel threads
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/mutex/" title="Kernel mutexes" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/mutex/">
          Kernel mutexes
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/semaphore/" title="Kernel semaphores" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/semaphore/">
          Kernel semaphores
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/spinlock/" title="EVL Spinlocks" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/spinlock/">
          EVL Spinlocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/flag/" title="Event flags" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/flag/">
          Event flags
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/clock/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/clock/">
          Clock devices
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/timer/">
          Timers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/xbuf/" title="Using cross-buffers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/xbuf/">
          Using cross-buffers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/interrupts/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/interrupts/">
          Managing IRQs
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/build-steps/" title="Building EVL" class="dd-item 
        
        
        
        ">
      <a href="/core/build-steps/">
          &rsaquo; Building EVL
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/caveat/" title="Caveat" class="dd-item 
        
        
        
        ">
      <a href="/core/caveat/">
          &rsaquo; Caveat
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/todo/" title="TODO list" class="dd-item 
        
        
        
        ">
      <a href="/todo/">
          &#9656; TODO
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ports/" title="Status of EVL ports" class="dd-item 
        
        
        
        ">
      <a href="/ports/">
          &#9656; Ports
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/faq/" title="FAQ" class="dd-item 
        
        
        
        ">
      <a href="/faq/">
          &#9656; FAQ
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Evenless</a> > <a href='/dovetail/'>Dovetail interface</a> > Alternate scheduling
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#altsched-theory">Theory of operations</a></li>
<li><a href="#what-you-really-need-to-know-at-this-point">What you really need to know at this point</a></li>
<li><a href="#migrating-between-execution-stages">Migrating between execution stages</a>
<ul>
<li><a href="#oob-switch">Out-of-band switch</a></li>
<li><a href="#inband-switch">In-band switch</a></li>
</ul></li>
<li><a href="#context-switching">Dovetail context switching</a></li>
<li><a href="#the-event-notifier">The event notifier</a>
<ul>
<li><a href="#out-of-band-exception-handling">Out-of-band exception handling</a></li>
<li><a href="#system-calls">System calls</a></li>
<li><a href="#in-band-events">In-band events</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Alternate scheduling</h1>
          

        




<p>Dovetail promotes the idea that a <em>dual kernel</em> system should keep the
functional overlap between the kernel and the autonomous core
minimal. To this end, a task from such core should be merely seen as a
regular task with additional scheduling capabilities guaranteeing very
low and bounded response times. To support such idea, Dovetail enables
kthreads and regular user tasks to run alternatively in the
out-of-band execution context introduced by the interrupt pipeline
(aka <em>oob</em> stage), or the common in-band kernel context for GPOS
operations (aka <em>in-band</em> stage).</p>

<p>As a result, autonomous core applications in user-space benefit from
the common Linux programming model - including virtual memory
protection -, and still have access to the main kernel services when
carrying out non time-critical work.</p>

<p>Dovetail provides mechanisms to autonomous cores for supporting this
as follows:</p>

<ul>
<li><p>services for moving Linux tasks back and forth between the in-band
and out-of-band stages in an orderly and safe way, properly
synchronizing the operation between the two schedulers involved.</p></li>

<li><p>notifications about in-band events the autonomous core may want to
know about for maintaining its own version of the current task&rsquo;s
state.</p></li>

<li><p>notifications about events such as faults, syscalls and other
exceptions issued from the out-of-band execution stage.</p></li>

<li><p>integrated support for performing context switches between
out-of-band tasks, including memory context and FPU management.</p></li>
</ul>

<h2 id="altsched-theory">Theory of operations</h2>

<ul>
<li><p>a Linux task running in user-space, or a kernel thread, need to
initialize the alternate scheduling feature for themselves with a
call to <code>dovetail_init_altsched()</code>. For instance, the EVL core does
so as part of the attachment process of a thread to the autonomous
core when <a href="/core/user-api/thread/#evl_attach_self">evl_attach_self()</a> is called by
the application.</p></li>

<li><p>once the alternate scheduling feature is initialized, the task
should enable it by a call to <code>dovetail_start_altsched()</code>. From this
point, that task:</p>

<ul>
<li><p>can switch between the in-band and out-of-band execution stages
freely.</p></li>

<li><p>can emit out-of-band system calls the autonomous core can handle.</p></li>

<li><p>is tracked by Dovetail&rsquo;s notification system, so that in-band and
out-of-band events which may involve such task are dispatched to
the core.</p></li>

<li><p>can be involved in Dovetail-based context switches triggered by
the autonomous core, independently from the scheduling operations
carried out by the main kernel.</p></li>
</ul>

<p>Conversely, <code>dovetail_stop_altsched()</code> disables the notifications
for a task, which is likely to be detached from the autonomous core
later on.</p></li>

<li><p>at any point in time, any Linux task is either controlled by the
main kernel or by the autonomous core, scheduling-wise. There cannot
be any overlap (for obvious reasons):</p>

<ul>
<li><p>a task which is currently scheduled by the autonomous core runs or
sleeps on the out-of-band stage. At the same time, such task is
deemed to be sleeping in <code>TASK_INTERRUPTIBLE</code> state for the main
kernel.</p></li>

<li><p>conversely, a task which is controlled by the main kernel runs or
sleeps on the in-band stage. It must be considered as blocked on
the other side. For instance, the EVL core defines the <code>T_INBAND</code>
blocking condition for representing such state.</p></li>
</ul></li>

<li><p>since the out-of-band stage receives interrupts first, regardless of
any interrupt masking which may be in effect for the ongoing in-band
work, the autonomous core can run <a href="/dovetail/pipeline/#two-stage-pipeline">high-priority interrupt
handlers</a> then
reschedule with no delay.</p></li>

<li><p>tasks may switch back and forth between the in-band and out-of-band
stages at will. However, this comes at a cost:</p>

<ul>
<li><p>the process of switching stages is heavyweight, it includes a
double scheduling operation at least (i.e. one to suspend on the
exited stage, one to resume from the opposite stage).</p></li>

<li><p><strong>only</strong> the out-of-band stage guarantees bounded response times
to external and internal events. Therefore, a task which leaves
the out-of-band stage for resuming in-band looses such guarantee,
until it has fully switched back to out-of-band context at some
point later.</p></li>
</ul></li>

<li><p>at any point in time, the autonomous core keeps the CPU busy until
no more task it knows about is runnable on that CPU, on the
out-of-band stage. When the out-of-band activity quiesces, the core
is expected to relinquish the CPU to the in-band stage by scheduling
in the context which was originally preempted. This is commonly done
by having a task placeholder with the lowest possible priority
represent the main kernel and its in-band context linked to each
per-CPU run queue maintained by the autonomous core.</p></li>

<li><p>once the in-band context resumes, interrupt events which have no
out-of-band handlers are delivered to the regular in-band IRQ
handlers installed by the main kernel, if the <a href="/dovetail/pipeline/optimistic/#virtual-i-flag">virtual masking
state</a> allows it.</p></li>
</ul>

<p><img src="/images/altsched.png" alt="Alt text" title="Alternate scheduling" /></p>

<h2 id="what-you-really-need-to-know-at-this-point">What you really need to know at this point</h2>

<p>There is a not-so-subtle but somewhat confusing distinction between
<em>running a Linux task out-of-band</em>, and running whatever code from the
<em>out-of-band interrupt stage</em>.</p>

<ul>
<li><p>In the first case, the task is not controlled by the main kernel
scheduler anymore, but runs under the supervision of the autonomous
core. This is obtained by performing an <a href="#oob-switch">out-of-band switch</a> for a task.</p></li>

<li><p>In the other case, the current underlying context (task or whatever
else) may or may not be controlled by the main kernel, but the
interrupt pipeline machinery has switched the CPU to out-of-band
mode, which means that only interrupts bearing the IRQF_OOB flag are
delivered. Typically, <a href="/dovetail/pipeline/usage/stage_escalation/"><code>run_oob_call()</code></a> is a service
provided by the interrupt pipeline which executes a function call
over this context, without requiring the calling task to be
scheduled by the autonomous core.</p></li>
</ul>

<p>You will also find references to pseudo-routines called
<code>core_schedule()</code>, <code>core_suspend_task()</code> or <code>core_resume_task()</code> in
various places. Don&rsquo;t look for them into the code, they don&rsquo;t actually
exist: those routines are mere placeholders for the corresponding
services you would provide in your autonomous core. For instance, the
EVL core implements them as <code>evl_schedule()</code>, <code>evl_suspend_thread()</code>
and <code>evl_release_thread()</code>.</p>

<p>You may want to keep this in mind when going through the rest of this
document.</p>

<h2 id="migrating-between-execution-stages">Migrating between execution stages</h2>

<h3 id="oob-switch">Out-of-band switch</h3>

<p>Switching out-of-band is the operation by which a Linux task moves
under the control of the alternate scheduler brought in the main
kernel by the autonomous core. From that point, the scheduling
decisions are made by this core regarding that task.</p>

<p>There are two reasons a Linux task may switch out-of-band:</p>

<ul>
<li><p>either it has requested it explicitly using a system call provided
by the autonomous core such as EVL&rsquo;s <a href="/core/user-api/thread/#evl_switch_oob">evl_switch_oob()</a>.</p></li>

<li><p>or the autonomous core has forced such transition, in response to
some request this task did, such as issuing a system call which can
only be handled from the out-of-band stage. This behavior is
enforced by the <a href="/core/user-api/thread/#thread-element">EVL core</a> too.</p></li>
</ul>

<p>Using Dovetail, a task which executes on the in-band stage moves
out-of-band following this sequence of actions:</p>

<ol>
<li><p>this task calls <code>dovetail_leave_inband()</code>, which prepares for the
transition, puts the caller to sleep (<code>TASK_INTERRUPTIBLE</code>) then
reschedules immediately. At this point, the migrating task is in
flight to the out-of-band stage. <code>schedule()</code> resumes the next
in-band task which should run on the current CPU.</p></li>

<li><p>as the next in-band task context resumes, the scheduling tail code
checks for any task pending transition to out-of-band stage, <em>before</em>
the CPU is fully relinquished to the resuming in-band task. This check
is performed by the <code>inband_switch_tail()</code> call present in the main
scheduler. Such call has two purposes:</p>

<ul>
<li><p>detect when a task is in flight to the out-of-band stage, so that
we can notify the autonomous core for finalizing the migration
process.</p></li>

<li><p>detect when a task is resuming on the out-of-band stage, which
happens when the autonomous core switches context back to the
current task, once the migration process is complete.</p></li>
</ul></li>
</ol>

<p>When switching out-of-band, case #1 is met, which triggers a call to
the <code>resume_oob_task()</code> handler the autonomous core should implement
for completing the transition. This would typically mean: unblock the
migrating task from the standpoint of its own scheduler, then
reschedule. In the following flowchart, <code>core_resume_task()</code> and
<code>core_schedule()</code> stand for these two operations, with each dotted
link representing a context switch:</p>

<div class="mermaid" align="left">
graph LR;
    S("start transition") --> A
    A["dovetail_leave_inband()"] --> B["schedule()"]
    B -.-> C["inband_switch_tail()"]
    C --> D{task in flight?}
    D -->|Yes| E["resume_oob_task()"]
    D -->|No| F{out-of-band?}
    E --> G["core_resume_task()"]
    G --> H["core_schedule()"]
    F -->|Yes| I(transition complete)
    F -->|No| J(regular switch tail)
    H -.-> C
</div>


<p>At the end of this process, we should have observed a double context
switch, with the migrating task offloaded to the out-of-band
scheduler:</p>

<p><img src="/images/oob_switch.png" alt="Alt text" title="Out-of-band switch" /></p>

<div class="notices tip" ><p><code>evl_switch_oob()</code> implements the switch to out-of-band context in the
EVL core, with support from <code>evl_release_thread()</code> and
<code>evl_schedule()</code> for resuming and rescheduling threads respectively.</p>
</div>


<h3 id="inband-switch">In-band switch</h3>

<p>Switching in-band is the operation by which a Linux task moves under
the control of the main scheduler, coming from the out-of-band
execution stage. From that point, the scheduling decisions are made by
the main kernel regarding that task.</p>

<p>There are several reasons a Linux task which was running out-of-band
so far may have to switch in-band:</p>

<ul>
<li><p>it has requested it explicitly using a system call provided by the
autonomous core such as EVL&rsquo;s <a href="/core/user-api/thread/#evl_switch_inband">evl_switch_inband()</a>.</p></li>

<li><p>the autonomous core has forced such transition for a task running in
user-space:</p>

<ul>
<li><p>in response to some request this task did, such as issuing a
regular system call which can only be handled from the in-band
stage. Typically, this behavior is enforced by the <a href="/core/user-api/thread/#thread-element">EVL core</a>.</p></li>

<li><p>because the task received a synchronous fault or exception, such
as a memory access violation, FPU exception and so on. A demotion
is required, because handling such events directly from the
out-of-band stage would require a fair amount of code duplication,
and most likely raise all sorts of funky conflicts between the
out-of-band handlers and several in-band sub-systems. Besides,
there is not much point in expecting real-time guarantees from a
code that basically fixes up a situation caused by a
dysfunctioning application in the first place.</p></li>

<li><p>a signal is pending for the task. Because the main kernel logic
may require signals to be acknowledged by the recipient, we have
to transition through the in-band stage to make sure the pending
signal(s) will be delivered asap.</p></li>
</ul></li>
</ul>

<p>Using Dovetail, a task which executes on the out-of-band stage moves
in-band following this sequence of actions:</p>

<ol>
<li><p>the execution of an in-band handler is scheduled from the context
of the migrating task on the out-of-band stage. Once it runs, this
handler should call <code>wake_up_process()</code> to unblock that task from
the standpoint of the main kernel scheduler, since it is sleeping
in <code>TASK_INTERRUPTIBLE</code> state there. Typically, the
<a href="/dovetail/pipeline/porting/irqflow/#irq-work"><em>irq_work</em></a> mechanism can
be used for this, because:</p>

<ul>
<li><p>as extended by the interrupt pipeline support, this interface can
be used from the out-of-band stage.</p></li>

<li><p>the handler is guaranteed to run on the CPU from which the
request was issued. Because the in-band work will wait until the
out-of-band activity quiesces on that CPU, this in turn ensures
that all other operations we have to carry out from the
out-of-band stage for preparing the migration are done before the
task is woken up eventually.</p></li>
</ul></li>

<li><p>the autonomous core blocks/suspends the migrating task,
rescheduling immediately afterwards. For instance, the EVL core
adds the <code>T_INBAND</code> block bit to the task&rsquo;s state for this purpose.</p></li>

<li><p>at some point later, the out-of-band context is exited by the
current CPU when no more out-of-band work is left, causing the
in-band kernel code to resume execution at the latest preemption
point. The handler scheduled at step #1 eventually runs, waking up
the migrating task from the standpoint of the main kernel. The
<code>TASK_RUNNING</code> state is set for the task.</p></li>

<li><p>the migrating task resumes from the tail scheduling code of the
alternate scheduler, where it suspended in step #2. Noticing the
migration, the core calls <code>dovetail_resume_inband()</code> eventually,
for finalizing the transition of the incoming task to the in-band
stage.</p></li>
</ol>

<p>In the following flowchart, <code>core_suspend_task()</code> and
<code>core_schedule()</code> stand for the operations described at step #2, with
each dotted link representing a context switch. The out-of-band idle
state represents the CPU transitioning from out-of-band to in-band
execution stage, as the core has no more out-of-band task to schedule:</p>

<div class="mermaid" align="left">
graph LR;
    S("start transition") --> A
    A["irq_work(wakeup_req)"] --> B["core_suspend_task()"]
    B --> C["core_schedule()"]
    C -.-> Y((OOB idle))
    Y -.-> D["wake_up_process()"]
    D --> E["schedule()"]
    E -.-> X["out-of-band switch tail"]
    X --> G["dovetail_resume_inband()"]
    G --> I("transition complete")
</div>


<p>At the end of this process, the task has transitioned from a running
state to a blocked state in the autonomous core, and conversely from
<code>TASK_INTERRUPTIBLE</code> to <code>TASK_RUNNING</code> in the main scheduler.</p>

<p><img src="/images/inband_switch.png" alt="Alt text" title="In-band switch" /></p>

<div class="notices tip" ><p><code>evl_switch_inband()</code> implements the switch to in-band context in the
EVL core, with support from <code>evl_suspend_thread()</code> and
<code>evl_schedule()</code> for suspending and rescheduling threads respectively.</p>
</div>


<h2 id="context-switching">Dovetail context switching</h2>

<p>Dovetail allows an autonomous core embedded into the main kernel to
schedule a set of Linux tasks <em>out-of-band</em> compared to the regular
<em>in-band</em> kernel work, so that:</p>

<ul>
<li><p>the worse-case response time of such tasks only depends on the
performance of a software core which has a limited complexity.</p></li>

<li><p>the main kernel&rsquo;s logic does not have to cope with stringent bounded
response time requirements, which otherwise tends to lower the
throughput while making the design, implementation and maintenance
significantly more complex.</p></li>
</ul>

<p>The flowchart below represents the typical context switch sequence
an autonomous core should implement, from the context of the outgoing
<em>PREV</em> task to the incoming <em>NEXT</em> task:</p>

<div class="mermaid" align="left">
graph LR;
    S(PREV) --> A["core_schedule()"]
    A --> B{in-band IRQ stage?}
    B -->|Yes| D["jump out-of-band"]
    D --> A
    B -->|No| C["pick NEXT"]
    C --> P{PREV == NEXT?}
    P -->|Yes| Q(no change)
    P -->|No| E{PREV == idle?}
    E -->|Yes| F["dovetail_resume_oob()"]
    E -->|No| H["dovetail_context_switch()"]
    F --> H
    H -.-> I(NEXT)
</div>


<p>Those steps are:</p>

<ol>
<li><p><code>core_schedule()</code> is called over the <em>PREV</em> context to check for
the <em>NEXT</em> task to schedule, by priority order. If <em>PREV</em> still has
the highest priority among runnable tasks, the sequence stops
there. CAVEAT: the core <em>must make sure to perform context switches
from the out-of-band interrupt stage</em>, otherwise weird things may
happen down the road. <a href="/dovetail/pipeline/usage/stage_escalation/"><code>run_oob_call()</code></a> is a routine
provided by the interrupt pipeline which may help there. See
<code>evl_schedule()</code> in the EVL core for a typical usage.</p></li>

<li><p>If <em>NEXT</em> <strong>is not</strong> the <a href="#altsched-theory">low priority placeholder task</a> but <em>PREV</em> is, we will be preempting the
in-band kernel: in this case, we must tell the kernel about such
preemption by a call to <code>dovetail_resume_oob()</code>. This routine saves
all context deemed necessary to restore it later on when the core
switches back to the in-band execution stage. Otherwise, if <em>NEXT</em> is
the placeholder task, there is no out-of-band task waiting for the
CPU, and we will branch back to the last preemption point that led
to calling <code>dovetail_resume_oob()</code> during the converse transition.</p></li>

<li><p><code>dovetail_context_switch()</code> is called, switching the memory context
as/if required, and the CPU register file to <em>NEXT</em>&rsquo;s, saving <em>PREV</em>&rsquo;s
in the same move.</p></li>

<li><p><em>NEXT</em> resumes from its latest switching point, which may be:</p>

<ul>
<li><p>the switch tail code in <code>core_schedule()</code>, if <em>NEXT</em> was running
out-of-band prior to sleeping.</p></li>

<li><p>the switch tail code of <code>schedule()</code> if <em>NEXT</em> is completing an
<a href="#oob-switch">out-of-band switch</a>.</p></li>
</ul></li>
</ol>

<h2 id="the-event-notifier">The event notifier</h2>

<p>Once <code>dovetail_start_altsched()</code> has been called for a Linux task, it
may receive events of interest with respect to running under the
supervision of an autonomous core. Those events are delivered by
invoking <em>__weak</em> handlers which should by overriden by this
core.</p>

<h3 id="out-of-band-exception-handling">Out-of-band exception handling</h3>

<p>If a processor exception is raised while the CPU is busy running a
task on the out-of-band stage (e.g. due to some invalid memory access,
bad instruction, FPU or alignment error etc.), the <a href="#inband-switch">task has to leave
such context</a> before it may run the
in-band fault handler. Dovetail notifies the core about incoming
exceptions early from the low-level fault trampolines, but only when
some out-of-band code was running when the exception was taken. The
core may then fix up the current context, such as switching to the
in-band execution stage.</p>

<div class="notices tip" ><p>Enabling debuggers to trace tasks running on the out-of-band stage
involves dealing with debug traps <code>ptrace()</code> may poke into the
debuggee&rsquo;s code for breakpointing.</p>
</div>


<p>The notification is delivered to the <code>handle_oob_trap()</code> handler the
core should override for receiving those events (<em>__weak</em>
binding). <code>handle_oob_trap()</code> is passed the exception code as defined
in <em>arch/*/include/asm/dovetail.h</em>, and a pointer to the register
frame of the faulting context (<em>struct pt_regs</em>).</p>

<p>Interrupts are <strong>disabled</strong> in the CPU when this handler is called.</p>

<h3 id="system-calls">System calls</h3>

<p>The autonomous core is likely to introduce its own set of system calls
application tasks may invoke. From the standpoint of the main kernel,
this is a foreign set of calls, which can be distinguished
unambiguously from regular ones.</p>

<p>If a task attached to the core issues any system call, regardless of
which of the kernel or the core should handle it, the latter must be
given the opportunity to:</p>

<ul>
<li><p>handle the request directly, possibly switching the caller to
out-of-band context first if required.</p></li>

<li><p>pass the request downward to the normal system call path on the
in-band stage, possibly switching the caller to in-band context if
needed.</p></li>
</ul>

<p>Dovetail intercepts system calls early in the kernel entry code,
delivering them to one of these handlers the core should override:</p>

<ul>
<li><p>the call is delivered to the <code>handle_oob_syscall()</code> handler if the
system call number is not in the valid range for the in-band kernel -
i.e. it has to belong to the core instead -, and the caller issued the
request from the out-of-band context. This is the fast path, when a
task running out-of-band is requesting a service the core provides.</p></li>

<li><p><code>handle_pipelined_syscall()</code> is a slower path, in which this handler
is probed for the appropriate execution stage in order to handle the
request.  In this case, the calling logic is as follows:</p></li>
</ul>

<div class="mermaid" align="left">
graph LR;
    S("from out-of-band IRQ stage") --> A
    A["handle_pipelined_syscall()"] --> B{returned zero?}
    B -->|Yes| C{on in-band stage?}
    B -->|No| R(done)
    C -->|Yes| Q(handle as regular kernel syscall)
    C -->|No| P[switch to in-band IRQ stage]
    P --> A
</div>


<p>In the flowchart above, <code>handle_pipelined_syscall()</code> should return
zero if it wants Dovetail to propagate the unhandled system call down
the pipeline, non-zero if the request was handled. The propagation is
carried out:</p>

<ul>
<li><p>first by re-running <code>handle_pipelined_syscall()</code> in the in-band
context coming from the out-of-band one.</p></li>

<li><p>then by passing the syscall to the regular in-band system call
handler in the assembly entry code eventually, if it remained
unhandled by <code>handle_pipelined_syscall()</code>.</p></li>
</ul>

<p>Interrupts are <strong>enabled</strong> in the CPU when any of these handlers is
called.</p>

<div class="notices note" ><p>The core may need to switch the calling task to the converse execution
stage (i.e. in-band &lt;-&gt; out-of-band) either from the
<code>handle_oob_syscall()</code> or <code>handle_pipelined_syscall()</code> handlers, this
is fine. Dovetail would notice and reconcile its logic according to
the current stage on return of these handlers.</p>
</div>


<h3 id="in-band-events">In-band events</h3>

<p>The last set of notifications involves pure in-band events which the
autonomous core may need to know about, as they may affect its own
task management. Except for INBAND_PROCESS_CLEANUP which is called for
<em>any</em> exiting user-space task, all other notifications are only issued
for tasks bound to the core (which may involve kthreads).</p>

<p>The notification is delivered to the <code>handle_inband_event()</code> handler.
Interrupts are <strong>enabled</strong> in the CPU when this handler is called.</p>

<p>The notification handler is given the event type code, and a single
pointer argument which relates to the event type.</p>

<p>The following events are defined (see <em>include/linux/dovetail.h</em>):</p>

<ul>
<li>INBAND_TASK_SCHEDULE(struct task_struct *next)</li>
</ul>

<p>sent in preparation of a context switch, right before the memory
  context is switched to <em>next</em>.</p>

<ul>
<li>INBAND_TASK_SIGNAL(struct task_struct *target)</li>
</ul>

<p>sent when <em>target</em> is about to receive a signal. The core may decide
  to schedule a transition of the recipient to the in-band stage in
  order to have it handle that signal asap, which is required for
  keeping the kernel sane. This notification is always sent from the
  context of the issuer.</p>

<ul>
<li>INBAND_TASK_MIGRATION(struct dovetail_migration_data *p)</li>
</ul>

<p>sent when p-&gt;task is about to move to CPU p-&gt;dest_cpu.</p>

<ul>
<li>INBAND_TASK_EXIT(struct task_struct *current)</li>
</ul>

<p>sent from <code>do_exit()</code> before the current task has dropped the files
  and mappings it owns.</p>

<ul>
<li>INBAND_PROCESS_CLEANUP(struct mm_struct *mm)</li>
</ul>

<p>sent before <em>mm</em> is entirely dropped, before the mappings are
  exited. Per-process resources which might be maintained by the
  core could be released there, as all tasks have exited.</p>


<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/dovetail/pipeline/usage/synthetic/" title="Synthetic IRQs"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/dovetail/rulesofthumb/" title="Rules Of Thumb" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1553763591"></script>
    <script src="/js/perfect-scrollbar.min.js?1553763591"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1553763591"></script>
    <script src="/js/jquery.sticky.js?1553763591"></script>
    <script src="/js/featherlight.min.js?1553763591"></script>
    <script src="/js/html5shiv-printshiv.min.js?1553763591"></script>
    <script src="/js/highlight.pack.js?1553763591"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1553763591"></script>
    <script src="/js/learn.js?1553763591"></script>
    <script src="/js/hugo-learn.js?1553763591"></script>

    <link href="/mermaid/mermaid.css?1553763591" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1553763591"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
  </body>
</html>
