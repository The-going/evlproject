<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.37.1" />
    <meta name="description" content="Evenless co-kernel">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Interrupt flow :: Evenless core documentation</title>

    
    <link href="/css/nucleus.css?1552811554" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1552811554" rel="stylesheet">
    <link href="/css/hybrid.css?1552811554" rel="stylesheet">
    <link href="/css/featherlight.min.css?1552811554" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1552811554" rel="stylesheet">
    <link href="/css/auto-complete.css?1552811554" rel="stylesheet">
    <link href="/css/theme.css?1552811554" rel="stylesheet">
    <link href="/css/hugo-theme.css?1552811554" rel="stylesheet">
    
      <link href="/css/theme-evl.css?1552811554" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1552811554"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/dovetail/pipeline/porting/irqflow/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/evl-silver.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1552811554"></script>
<script type="text/javascript" src="/js/auto-complete.js?1552811554"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/evenless.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1552811554"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/dovetail/" title="Dovetail interface" class="dd-item 
        parent
        
        
        ">
      <a href="/dovetail/">
          &#9656; Dovetail interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/" title="Interrupt pipeline" class="dd-item 
        parent
        
        
        ">
      <a href="/dovetail/pipeline/">
          &rsaquo; Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/usage/" title="Kernel API" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/usage/">
          &rsaquo; Kernel API
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_push/" title="Installing the out-of-band stage" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_push/">
        OOB stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/dovetail/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/dovetail/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/dovetail/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/dovetail/pipeline/rulesofthumb/">
        Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/porting/" title="Porting" class="dd-item 
        parent
        
        
        ">
      <a href="/dovetail/pipeline/porting/">
          &rsaquo; Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item ">
        <a href="/dovetail/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item ">
        <a href="/dovetail/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/dovetail/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/dovetail/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/dovetail/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/dovetail/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item active">
        <a href="/dovetail/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/dovetail/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/optimistic/">
        Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/altsched/" title="Alternate Task Control" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/altsched/">
          &rsaquo; Alternate Task Control
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/core/" title="The EVL core" class="dd-item 
        
        
        
        ">
      <a href="/core/">
          &#9656; Real-time core
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/" title="The EVL library" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/">
          &rsaquo; Application interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/thread/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/thread/">
          Thread
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/mutex/" title="Mutex" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/mutex/">
          Mutex
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/condvar/" title="Condition variable" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/condvar/">
          Condition variable
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/semaphore/" title="Counting semaphore" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/semaphore/">
          Counting semaphore
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/clock/" title="Clock element" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/clock/">
          Clocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/timer/">
          Timer(fd)
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/xbuf/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/xbuf/">
          Cross-buffer
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/proxy/" title="File proxy" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/proxy/">
          File proxy
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/poll/" title="Polling file descriptors" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/poll/">
          Polling file descriptors
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/io/" title="Out-of-band I/O services" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/io/">
          Out-of-band I/O
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/scheduling/" title="Scheduling policies" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/scheduling/">
          Scheduling policies
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/utils/" title="Utilities" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/utils/">
          Utilities
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/" title="Driver interface" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/">
          &rsaquo; Driver interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/file/" title="File description" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/file/">
          File description
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/kthread/" title="Kernel threads" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/kthread/">
          Kernel threads
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/mutex/" title="Kernel mutexes" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/mutex/">
          Kernel mutexes
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/semaphore/" title="Kernel semaphores" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/semaphore/">
          Kernel semaphores
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/spinlock/" title="EVL Spinlocks" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/spinlock/">
          EVL Spinlocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/flag/" title="Event flags" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/flag/">
          Event flags
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/clock/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/clock/">
          Clock devices
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/timer/">
          Timers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/xbuf/" title="Using cross-buffers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/xbuf/">
          Using cross-buffers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/interrupts/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/interrupts/">
          Managing IRQs
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/build-steps/" title="Building EVL" class="dd-item 
        
        
        
        ">
      <a href="/core/build-steps/">
          &rsaquo; Building EVL
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/caveat/" title="Caveat" class="dd-item 
        
        
        
        ">
      <a href="/core/caveat/">
          &rsaquo; Caveat
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/todo/" title="TODO list" class="dd-item 
        
        
        
        ">
      <a href="/todo/">
          &#9656; TODO
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ports/" title="Status of EVL ports" class="dd-item 
        
        
        
        ">
      <a href="/ports/">
          &#9656; Ports
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/faq/" title="FAQ" class="dd-item 
        
        
        
        ">
      <a href="/faq/">
          &#9656; FAQ
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Evenless</a> > <a href='/dovetail/'>Dovetail interface</a> > <a href='/dovetail/pipeline/'>Interrupt pipeline</a> > <a href='/dovetail/pipeline/porting/'>Porting</a> > Interrupt flow
          
         
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#pipelined-interrupt-flow">Pipelined interrupt flow</a>
<ul>
<li><a href="#irq-flow-handling">IRQ flow handling</a></li>
</ul></li>
<li><a href="#irqchip-fixup">IRQ chip drivers</a></li>
<li><a href="#kernel-preemption-control-preempt">Kernel preemption control (PREEMPT)</a></li>
<li><a href="#irq-work">Extended IRQ work API</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Interrupt flow</h1>
          

        




<h2 id="pipelined-interrupt-flow">Pipelined interrupt flow</h2>

<p>Interrupt pipelining involves a basic change in controlling the
interrupt flow: <code>handle_domain_irq()</code> from the IRQ domain API
redirects all parent IRQs to the pipeline entry by calling
<code>generic_pipeline_irq()</code>.</p>

<blockquote>
<p>Redirecting the interrupt flow to the pipeline</p>
</blockquote>

<pre><code class="language-markdown">    asm_irq_entry
       -&gt; irqchip_handle_irq()
          -&gt; handle_domain_irq()
             -&gt; generic_pipeline_irq()
                -&gt; irq_flow_handler()
                   -&gt; handle_oob_irq()
</code></pre>

<h3 id="irq-flow-handling">IRQ flow handling</h3>

<p>Generic flow handlers acknowledge the incoming IRQ event in the
hardware as usual, by calling the appropriate <code>irqchip</code> routine
(e.g. <code>irq_ack()</code>, <code>irq_eoi()</code>) according to the interrupt
type. However, the flow handlers do not immediately invoke the in-band
interrupt handlers. Instead, they hand the event over to the pipeline
core by calling <code>handle_oob_irq()</code>.</p>

<p>If an out-of-band handler exists for the interrupt received,
<code>handle_oob_irq()</code> invokes it immediately, after switching the
execution context to the oob stage if not current yet. Otherwise, the
event is marked as pending in the in-band stage&rsquo;s log for the current
CPU.</p>

<div class="notices tip" ><p>This is important to notice: <em>every</em> interrupt which is <em>not</em> handled
by an out-of-band handler will end up into the in-band stage&rsquo;s event
log. This means that all external interrupts must have a handler in
the in-band code - which should be the case for a sane kernel anyway.</p>
</div>


<p>Once <code>generic_pipeline_irq()</code> has returned, if the preempted execution
context was running over the in-band stage unstalled, the pipeline
core synchronizes the interrupt state immediately, meaning that all
IRQs found pending in the in-band stage&rsquo;s log are immediately
delivered to their respective in-band handlers. In all other
situations, the IRQ frame is left immediately without running those
handlers. The IRQs may remain pending until the in-band code resumes
from preemption, then clears the <a href="/dovetail/pipeline/optimistic/#virtual-i-flag">virtual interrupt disable
flag</a>,
which would cause the interrupt state to be synchronized, running the
in-band handlers eventually.</p>

<p>For delivering an IRQ to the in-band handlers, the interrupt flow
handler is called again by the pipeline core. When this happens, the
flow handler processes the interrupt as usual, skipping the call to
<code>handle_oob_irq()</code> though.</p>

<div class="notices tip" ><p>Yes, you did read it right: interrupt flow handlers may run twice for
a single IRQ in Dovetail&rsquo;s pipelined interrupt model: firstly to
submit the event immediately to any out-of-band handler which may be
interested in it, finally to run the in-band handler(s) accepting that
event if it was not delivered to any out-of-band handler. You may
construe the meaning of calling <code>handle_oob_irq()</code> as <em>&ldquo;let&rsquo;s poll for
any out-of-band handler which might be interested in this event&rdquo;</em>.
This also means that any interrupt can have either an in-band or an
out-of-band handler, but not both.</p>
</div>


<p>In absence of any out-of-band handler for the event, the device may
keep asserting the interrupt signal until the cause has been lifted in
its own registers. At the same time, we might not be allowed to run
the in-band handler immediately over the current interrupt context if
the in-band stage is currently stalled, we would have to wait for the
in-band code to accept interrupts again. However, the interrupt
disable bit in the CPU would certainly be cleared in the meantime. For
this reason, depending on the interrupt type, the flow handlers as
modified by the pipeline code may have to mask the interrupt line
until the in-band handler has run from the in-band stage, lifting the
interrupt cause. This typically happens with level-triggered
interrupts, preventing the device from storming the CPU with a
continuous interrupt request.</p>

<p>Since all of the IRQ handlers sharing an interrupt line are either
in-band or out-of-band in a mutually exclusive way, such masking
cannot delay out-of-band events.</p>

<blockquote>
<p>The pathological case of deferring level-triggered IRQs</p>
</blockquote>

<pre><code class="language-markdown">    /* in-band stage stalled on entry, no OOB handler */
    asm_irq_entry
       ...
          -&gt; generic_pipeline_irq()
             ...
                &lt;IRQ logged, delivery deferred&gt;
    asm_irq_exit
    /*
     * CPU allowed to accept interrupts again with IRQ cause not
     * acknowledged in device yet =&gt; **IRQ storm**.
     */
    asm_irq_entry
       ...
    asm_irq_exit
    asm_irq_entry
       ...
    asm_irq_exit
</code></pre>

<div class="notices tip" ><p>The logic behind masking interrupt lines until events are processed at
some point later - out of the original interrupt context - also
applies to the threaded interrupt model. In this case, interrupt lines
may be masked until the IRQ thread is scheduled in, after the
interrupt handler clears the event cause eventually.</p>
</div>


<p>The logic for adapting flow handlers dealing with any kind of
interrupt to pipelining can be decomposed in the following steps:</p>

<ul>
<li><p>(optionally) enter the critical section protected by the IRQ
descriptor lock, if the interrupt is shared among processors
(e.g. device interrupts). If so, check if the interrupt handler may
run on the current CPU (<code>irq_may_run()</code>). By definition, no locking
would be required for per-CPU interrupts.</p></li>

<li><p>check whether we are entering the pipeline in order to deliver the
interrupt to any out-of-band handler registered for
it. <code>on_pipeline_entry()</code> returns a boolean value denoting this
situation.</p></li>

<li><p>if on pipeline entry, we should pass the event on to the pipeline
core by calling <code>handle_oob_irq()</code>. Upon return, this routine tells
the caller whether any out-of-band handler was fired for the
event.</p>

<ul>
<li><p>if so, we may assume that the interrupt cause is now cleared in
the device, and we may leave the flow handler, after having
restored the interrupt line into a normal state. In case of a
level-triggered interrupt which has been masked on entry to the
flow handler, we need to unmask the line before leaving.</p></li>

<li><p>if no out-of-band handler was called, we should have performed any
acknowledge and/or EOI to release the interrupt line, while
leaving it masked if required before exiting the flow handler. In
case of a level-triggered interrupt, we do want to leave it masked
for solving the pathological case with interrupt deferral
explained earlier.</p></li>
</ul></li>

<li><p>if not on pipeline entry (i.e. second entry of the flow handler),
then we must be running over the in-band stage, accepting interrupts,
therefore we should fire the in-band handler(s) for the incoming
event.</p></li>
</ul>

<p>The original code for handling level-triggered interrupts is adapted
to interrupt pipelining according to the rules above, as follows:</p>

<blockquote>
<p>Example: adapting the handler dealing with level-triggered IRQs</p>
</blockquote>

<pre><code>--- a/kernel/irq/chip.c
+++ b/kernel/irq/chip.c
void handle_level_irq(struct irq_desc *desc)
{
	raw_spin_lock(&amp;desc-&gt;lock);
	mask_ack_irq(desc);

 	if (!irq_may_run(desc))
 		goto out_unlock;
 
+	if (on_pipeline_entry()) {
+		if (handle_oob_irq(desc))
+			goto out_unmask;
+		goto out_unlock;
+	}
+
 	desc-&gt;istate &amp;= ~(IRQS_REPLAY | IRQS_WAITING);
 
 	/*
@@ -642,7 +686,7 @@ void handle_level_irq(struct irq_desc *desc)
 
 	kstat_incr_irqs_this_cpu(desc);
 	handle_irq_event(desc);
-
+out_unmask:
 	cond_unmask_irq(desc);

out_unlock:
	raw_spin_unlock(&amp;desc-&gt;lock);
}
</code></pre>

<p>This change reads as follows:</p>

<ul>
<li><p>on entering the pipeline, which means immediately over the interrupt
frame context set up by the CPU for receiving the event, tell the
pipeline core about the incoming IRQ.</p></li>

<li><p>if this IRQ was handled by an out-of-band handler
(<code>handle_oob_irq()</code> returns <em>true</em>), consider the event to have been
fully processed, unmasking the interrupt line before leaving. We
can&rsquo;t do more than this, simply because the in-band kernel code
might expect not to receive any interrupt at this point (i.e. the
<a href="/dovetail/pipeline/optimistic/#virtual-i-flag">virtual interrupt disable flag</a> might be set
for the in-band stage).</p></li>

<li><p>otherwise, keep the interrupt line masked until <code>handle_level_irq()</code>
is called again from a safe context for handling in-band interrupts,
at which point the event should be delivered to the in-band
interrupt handler of the main kernel. We have to keep the line
masked to prevent the IRQ storm which would certainly happen
otherwise, since no handler has cleared the cause of the interrupt
event in the device yet.</p></li>
</ul>

<h2 id="irqchip-fixup">IRQ chip drivers</h2>

<p><code>irqchip</code> drivers need to be specifically adapted for supporting the
pipelined interrupt model. The basic task is to ensure that the
following <code>struct irq_chip</code> handlers - if defined - can be called from
an out-of-band context safely:</p>

<ul>
<li><code>irq_mask()</code></li>
<li><code>irq_ack()</code></li>
<li><code>irq_mask_ack()</code></li>
<li><code>irq_eoi()</code></li>
<li><code>irq_unmask()</code></li>
</ul>

<p>Such handler is deemed safe to be called from out-of-band context when
it does not invoke <strong>any</strong> in-band kernel service, which might cause
an <a href="/dovetail/pipeline/optimistic/#no-inband-reentry">invalid context re-entry</a>.</p>

<p>The generic IRQ management core serializes calls to <code>irqchip</code> handlers
for a given IRQ by serializing access to its interrupt descriptor,
acquiring the per-descriptor <code>irq_desc::lock</code> spinlock.  Holding
<code>irq_desc::lock</code> when running a handler for any IRQ shared between all
CPUs ensures that a single CPU handles the event.  This - originally -
raw spinlock is automatically turned into a <a href="/dovetail/pipeline/usage/locking/#new-spinlocks">mutable
spinlock</a> when pipelining interrupts.</p>

<p>In addition, there might be inner spinlocks defined by some <code>irqchip</code>
drivers for serializing handlers accessing a common interrupt
controller hardware for <em>distinct</em> IRQs from multiple CPUs
concurrently. Adapting such spinlocked sections found in <code>irqchip</code>
drivers to support interrupt pipelining may involve <a href="/dovetail/pipeline/rulesofthumb/#spinlock-rule">converting the
related spinlocks</a> to hard
spinlocks.</p>

<p>Other section of code which were originally serialized by common
interrupt disabling may need to be made fully atomic for running
consistenly in pipelined interrupt mode. This can be done by
introducing hard masking with <code>hard_local_irq_save()</code>,
<code>hard_local_irq_restore()</code>.</p>

<p>Finally, <code>IRQCHIP_PIPELINE_SAFE</code> must be added to <code>struct
irqchip::flags</code> member of a pipeline-aware <code>irqchip</code> driver, in order
to notify the kernel that such controller can operate in pipelined
interrupt mode.</p>

<blockquote>
<p>Adapting the ARM GIC driver to interrupt pipelining</p>
</blockquote>

<pre><code>--- a/drivers/irqchip/irq-gic.c
+++ b/drivers/irqchip/irq-gic.c
@@ -93,7 +93,7 @@ struct gic_chip_data {
 
 #ifdef CONFIG_BL_SWITCHER
 
-static DEFINE_RAW_SPINLOCK(cpu_map_lock);
+static DEFINE_HARD_SPINLOCK(cpu_map_lock);
 
 #define gic_lock_irqsave(f)		\
 	raw_spin_lock_irqsave(&amp;cpu_map_lock, (f))
@@ -424,7 +424,8 @@ static const struct irq_chip gic_chip = {
 	.irq_set_irqchip_state	= gic_irq_set_irqchip_state,
 	.flags			= IRQCHIP_SET_TYPE_MASKED |
 				  IRQCHIP_SKIP_SET_WAKE |
-				  IRQCHIP_MASK_ON_SUSPEND,
+				  IRQCHIP_MASK_ON_SUSPEND |
+				  IRQCHIP_PIPELINE_SAFE,
 };
 
 void __init gic_cascade_irq(unsigned int gic_nr, unsigned int irq)
</code></pre>

<p>In some (rare) cases, we might have a bit more work for adapting an
interrupt chip driver. For instance, we might have to convert a
sleeping spinlock to a raw spinlock first, so that we can convert the
latter to a hard spinlock eventually. Hard spinlocks like raw ones
should be manipulated via the raw_spin_lock() API, unlike sleeping
spinlocks. This change makes even more sense as sleeping is not
allowed while running in the pipeline entry context anyway.</p>

<blockquote>
<p>Adapting the BCM2835 pin control driver to interrupt pipelining</p>
</blockquote>

<pre><code>--- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
@@ -90,7 +90,7 @@ struct bcm2835_pinctrl {
 	struct gpio_chip gpio_chip;
 	struct pinctrl_gpio_range gpio_range;
 
-	spinlock_t irq_lock[BCM2835_NUM_BANKS];
+	hard_spinlock_t irq_lock[BCM2835_NUM_BANKS];
 };
 
 /* pins are just named GPIO0..GPIO53 */
@@ -461,10 +461,10 @@ static void bcm2835_gpio_irq_enable(struct irq_data *data)
 	unsigned bank = GPIO_REG_OFFSET(gpio);
 	unsigned long flags;
 
-	spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
 	set_bit(offset, &amp;pc-&gt;enabled_irq_map[bank]);
 	bcm2835_gpio_irq_config(pc, gpio, true);
-	spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
 }
 
 static void bcm2835_gpio_irq_disable(struct irq_data *data)
@@ -476,12 +476,12 @@ static void bcm2835_gpio_irq_disable(struct irq_data *data)
 	unsigned bank = GPIO_REG_OFFSET(gpio);
 	unsigned long flags;
 
-	spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
 	bcm2835_gpio_irq_config(pc, gpio, false);
 	/* Clear events that were latched prior to clearing event sources */
 	bcm2835_gpio_set_bit(pc, GPEDS0, gpio);
 	clear_bit(offset, &amp;pc-&gt;enabled_irq_map[bank]);
-	spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
 }
 
 static int __bcm2835_gpio_irq_set_type_disabled(struct bcm2835_pinctrl *pc,
@@ -584,7 +584,7 @@ static int bcm2835_gpio_irq_set_type(struct irq_data *data, unsigned int type)
 	unsigned long flags;
 	int ret;
 
-	spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_lock_irqsave(&amp;pc-&gt;irq_lock[bank], flags);
 
 	if (test_bit(offset, &amp;pc-&gt;enabled_irq_map[bank]))
 		ret = __bcm2835_gpio_irq_set_type_enabled(pc, gpio, type);
@@ -596,7 +596,7 @@ static int bcm2835_gpio_irq_set_type(struct irq_data *data, unsigned int type)
 	else
 		irq_set_handler_locked(data, handle_level_irq);
 
-	spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
+	raw_spin_unlock_irqrestore(&amp;pc-&gt;irq_lock[bank], flags);
 
 	return ret;
 }
@@ -618,6 +618,7 @@ static struct irq_chip bcm2835_gpio_irq_chip = {
 	.irq_ack = bcm2835_gpio_irq_ack,
 	.irq_mask = bcm2835_gpio_irq_disable,
 	.irq_unmask = bcm2835_gpio_irq_enable,
+	.flags = IRQCHIP_PIPELINE_SAFE,
 };
 
 static int bcm2835_pctl_get_groups_count(struct pinctrl_dev *pctldev)
@@ -1047,7 +1048,7 @@ static int bcm2835_pinctrl_probe(struct platform_device *pdev)
 		for_each_set_bit(offset, &amp;events, 32)
 			bcm2835_gpio_wr(pc, GPEDS0 + i * 4, BIT(offset));
 
-		spin_lock_init(&amp;pc-&gt;irq_lock[i]);
+		raw_spin_lock_init(&amp;pc-&gt;irq_lock[i]);
 	}
 
 	err = gpiochip_add_data(&amp;pc-&gt;gpio_chip, pc);
</code></pre>

<div class="notices note" ><p><code>irq_set_chip()</code> will complain loudly with a kernel warning whenever
the <code>irqchip</code> descriptor passed does not bear the
<code>IRQCHIP_PIPELINE_SAFE</code> flag and CONFIG_IRQ_PIPELINE is enabled. Take
this warning as a sure sign that your port of the IRQ pipeline to the
target system is incomplete.</p>
</div>


<h2 id="kernel-preemption-control-preempt">Kernel preemption control (PREEMPT)</h2>

<p>When pipelining is enabled, <code>preempt_schedule_irq()</code> reconciles the
virtual interrupt state - which has not been touched by the assembly
level code upon kernel entry - with basic assumptions made by the
scheduler core, such as entering with (virtual) interrupts disabled.</p>

<h2 id="irq-work">Extended IRQ work API</h2>

<p>Due to the NMI-type nature of interrupts running out-of-band code,
such code might preempt in-band activities over the in-band stage in
the middle of a <a href="/dovetail/pipeline/optimistic/#no-inband-reentry">critical section</a>. For this
reason, it would be unsafe to call any in-band routine from an
out-of-band context.</p>

<p>However, we may schedule execution of in-band work handlers from
out-of-band code, using the regular <code>irq_work_queue()</code> service which
has been extended by the IRQ pipeline core. Such work request from the
oob stage is scheduled for running over the in-band stage on the
issuing CPU as soon as the out-of-band activity quiesces on this
processor. As its name implies, the work handler runs in (in-band)
interrupt context.</p>

<div class="notices note" ><p>The interrupt pipeline forces the use of a synthetic IRQ as a
notification signal for the IRQ work machinery, instead of a
hardware-specific interrupt vector. This special IRQ is labeled
<em>in-band work</em> when reported by <code>/proc/interrupts</code>.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/dovetail/pipeline/porting/arch/" title="Architecture-specific bits"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/dovetail/pipeline/porting/prerequisites/" title="Prerequisites" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1552811554"></script>
    <script src="/js/perfect-scrollbar.min.js?1552811554"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1552811554"></script>
    <script src="/js/jquery.sticky.js?1552811554"></script>
    <script src="/js/featherlight.min.js?1552811554"></script>
    <script src="/js/html5shiv-printshiv.min.js?1552811554"></script>
    <script src="/js/highlight.pack.js?1552811554"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1552811554"></script>
    <script src="/js/learn.js?1552811554"></script>
    <script src="/js/hugo-learn.js?1552811554"></script>

    <link href="/mermaid/mermaid.css?1552811554" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1552811554"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

