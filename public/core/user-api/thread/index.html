<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.37.1" />
    <meta name="description" content="Evenless project">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title> :: Evenless project</title>

    
    <link href="/css/nucleus.css?1554201814" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1554201814" rel="stylesheet">
    <link href="/css/hybrid.css?1554201814" rel="stylesheet">
    <link href="/css/featherlight.min.css?1554201814" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1554201814" rel="stylesheet">
    <link href="/css/auto-complete.css?1554201814" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1554201814" rel="stylesheet">
    <link href="/css/theme.css?1554201814" rel="stylesheet">
    <link href="/css/hugo-theme.css?1554201814" rel="stylesheet">
    
      <link href="/css/theme-evl.css?1554201814" rel="stylesheet">
    

    <script src="/js/jquery-3.3.1.min.js?1554201814"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/core/user-api/thread/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/evl-silver.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1554201814"></script>
<script type="text/javascript" src="/js/auto-complete.js?1554201814"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/evenless.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1554201814"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/dovetail/" title="Dovetail interface" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/">
          &#9656; Dovetail interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/" title="Interrupt pipeline" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/">
          &rsaquo; Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/optimistic/">
        &rsaquo; Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/porting/" title="Porting" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/porting/">
          &rsaquo; Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/dovetail/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/dovetail/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/dovetail/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/dovetail/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/dovetail/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item ">
        <a href="/dovetail/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/dovetail/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item ">
        <a href="/dovetail/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/pipeline/usage/" title="Kernel API" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/pipeline/usage/">
          &rsaquo; Kernel API
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_push/" title="Installing the out-of-band stage" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_push/">
        OOB stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/dovetail/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/dovetail/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/dovetail/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/dovetail/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/dovetail/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/dovetail/altsched/" title="Alternate scheduling" class="dd-item 
        
        
        
        ">
      <a href="/dovetail/altsched/">
          &rsaquo; Alternate scheduling
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/dovetail/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/dovetail/rulesofthumb/">
        &rsaquo; Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/core/" title="The EVL core" class="dd-item 
        parent
        
        
        ">
      <a href="/core/">
          &#9656; Real-time core
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/" title="The EVL library" class="dd-item 
        parent
        
        
        ">
      <a href="/core/user-api/">
          &rsaquo; Application interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/thread/" title="" class="dd-item 
        parent
        active
        
        ">
      <a href="/core/user-api/thread/">
          Thread
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/mutex/" title="Mutex" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/mutex/">
          Mutex
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/condvar/" title="Condition variable" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/condvar/">
          Condition variable
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/semaphore/" title="Counting semaphore" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/semaphore/">
          Counting semaphore
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/clock/" title="Clock element" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/clock/">
          Clocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/timer/">
          Timer(fd)
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/xbuf/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/xbuf/">
          Cross-buffer
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/proxy/" title="File proxy" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/proxy/">
          File proxy
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/poll/" title="Polling file descriptors" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/poll/">
          Polling file descriptors
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/io/" title="Out-of-band I/O services" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/io/">
          Out-of-band I/O
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/scheduling/" title="Scheduling policies" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/scheduling/">
          Scheduling policies
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/utils/" title="Utilities" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/utils/">
          Utilities
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/user-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/user-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/" title="Driver interface" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/">
          &rsaquo; Driver interface
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/file/" title="File description" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/file/">
          File description
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/kthread/" title="Kernel threads" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/kthread/">
          Kernel threads
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/mutex/" title="Kernel mutexes" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/mutex/">
          Kernel mutexes
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/semaphore/" title="Kernel semaphores" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/semaphore/">
          Kernel semaphores
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/spinlock/" title="EVL Spinlocks" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/spinlock/">
          EVL Spinlocks
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/flag/" title="Event flags" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/flag/">
          Event flags
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/clock/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/clock/">
          Clock devices
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/timer/" title="Timers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/timer/">
          Timers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/xbuf/" title="Using cross-buffers" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/xbuf/">
          Using cross-buffers
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/interrupts/" title="" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/interrupts/">
          Managing IRQs
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/kernel-api/function_index/" title="Function index" class="dd-item 
        
        
        
        ">
      <a href="/core/kernel-api/function_index/">
          Index
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/build-steps/" title="Building EVL" class="dd-item 
        
        
        
        ">
      <a href="/core/build-steps/">
          &rsaquo; Building EVL
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/core/caveat/" title="Caveat" class="dd-item 
        
        
        
        ">
      <a href="/core/caveat/">
          &rsaquo; Caveat
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/todo/" title="TODO list" class="dd-item 
        
        
        
        ">
      <a href="/todo/">
          &#9656; TODO
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ports/" title="Status of EVL ports" class="dd-item 
        
        
        
        ">
      <a href="/ports/">
          &#9656; Ports
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/faq/" title="FAQ" class="dd-item 
        
        
        
        ">
      <a href="/faq/">
          &#9656; FAQ
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Evenless</a> > <a href='/core/'>The EVL core</a> > <a href='/core/user-api/'>The EVL library</a> > 
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#thread-element">Thread element</a></li>
<li><a href="#thread-services">Thread services</a></li>
<li><a href="#can-evl-threads-run-in-kernel-space">Can EVL threads run in kernel space?</a></li>
<li><a href="#where-do-thread-devices-live">Where do thread devices live?</a></li>
<li><a href="#how-to-reach-a-remote-evl-thread">How to reach a remote EVL thread?</a></li>
<li><a href="#where-to-look-for-thread-information">Where to look for thread information?</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              
            </h1>
          

        




	

<h3 id="thread-element">Thread element</h3>

<p>The main kernel&rsquo;s thread is the basic execution unit in EVL. The most
common kind of EVL threads is a regular POSIX thread started by
<code>pthread_create(3)</code> which has attached itself to the EVL core by a
call to <a href="/core/user-api/thread/#evl_attach_self"><code>evl_attach_self()</code></a>. Once a
POSIX thread attached itself to EVL, it can:</p>

<ul>
<li><p>request real-time services to the core, exclusively by calling
routines available from the EVL library . In this case, and only in
this one, you get real-time guarantees for the caller. This is what
time-critical processing loops are supposed to use. Such request may
switch the calling thread to the out-of-band <a href="/dovetail/pipeline/#two-stage-pipeline">execution
stage</a>, for running under EVL&rsquo;s supervision in order to ensure
real-time behaviour.</p></li>

<li><p>invoke services from your favourite C library (<em>glibc</em>, <em>musl</em>,
<em>uClibc</em> etc.), which may end up issuing system calls to the main
kernel for carrying out the job. EVL may have to demote the caller
automatically from the EVL context to a runtime mode which is
compatible with using the main kernel services. As a result of this,
you get NO help from EVL for keeping short and bounded latency
figures anymore, but you do have access to any feature the main
kernel provides. This mode is normally reserved to initialization
and cleanup phases of your application. If you end up using them in
the middle of a would-be time-critical loop, well, something is
seriously wrong in this code.</p></li>
</ul>

<div class="notices info" ><p>A thread which is being scheduled by EVL instead of the main kernel is
said to be running <strong>out-of-band</strong>, as defined by <a href="/dovetail/pipeline/">Dovetail</a>. It remains in this mode
until it asks for a service which the main kernel provides.
Conversely, a thread which is being scheduled by the main kernel
instead of EVL is said to be running <strong>in-band</strong>, as defined by
<a href="/dovetail/pipeline/">Dovetail</a>. It remains
in this mode until it asks for a service which EVL can only provide
to the caller when it runs out-of-band.</p>
</div>


<h3 id="thread-services">Thread services</h3>

<hr />

<div class="proto"><a name="evl_attach_self"></a>
int evl_attach_self(const char *fmt, ...)
</div>


<p>EVL does not actually <em>create</em> threads; instead, it enables a regular
POSIX thread to invoke its real-time services once this thread has
attached to the EVL core.  evl_attach_self() is the library call which
requests such attachment. All you need to provide is a <em>unique</em> thread
name, which will be the name of the device element representing that
thread in the file system.</p>

<p>There is no requirement as of when evl_attach_self() should be called
in a thread&rsquo;s execution flow. You just have to call it before it
starts requesting EVL services. Note that the main thread of a process
is no different from any other thread to EVL. It may call
evl_attach_self() whenever you see fit, or not at all if you don&rsquo;t
plan to request EVL services from this context.</p>

<p><li><i>fmt</i><p>A printf-like format string to generate the thread name. A common way
of generating unique thread names is to add the calling process&rsquo;s
<em>pid</em> somewhere into the format string as illustrated in the
example. The generated name is used to form a file path, referring to
the new thread element&rsquo;s device in the file system. So this name must
contain only valid characters in this context, excluding slashes.</p>
</li></p>


<p><li><i>...</i><p>The optional variable argument list completing the format.</p>
</li></p>


<p>evl_attach_self() returns the file descriptor of the newly attached
thread on success. You may use this <em>fd</em> to submit requests for the
newly attached thread in other calls from the EVL library which ask
for a thread file descriptor. If the call fails, a negated error code
is returned instead:</p>

<ul>
<li><p>-EEXIST   The generated name is conflicting with an existing thread&rsquo;s
    name.</p></li>

<li><p>-EINVAL   The generated name is badly formed, likely containing
    invalid character(s), such as a slash. Keep in mind that
    it should be usable as a basename of a device element&rsquo;s file path.</p></li>

<li><p>-ENAMETOOLONG The overall length of the device element&rsquo;s file path including
    the generated name exceeds PATH_MAX.</p></li>

<li><p>-EMFILE   The per-process limit on the number of open file descriptors
    has been reached.</p></li>

<li><p>-ENFILE   The system-wide limit on the total number of open files
    has been reached.</p></li>

<li><p>-EPERM    The caller is not allowed to lock memory via a call to
    <code>mlockall(2)</code>. Since memory locking is a requirement for running
    EVL threads, no joy.</p></li>

<li><p>-ENOMEM   No memory available, whether the kernel could not
    lock down all of the calling process&rsquo;s virtual address
    space into RAM, or some other reason related to some
    process or driver eating way too much virtual or physical
    memory. You may start panicking.</p></li>

<li><p>-ENOSYS   The EVL core is not enabled in the running kernel.</p></li>
</ul>

<pre><code>#include &lt;evl/thread.h&gt;

static void *byte_crunching_thread(void *arg)
{
	int efd;

	/* Attach the current thread to the EVL core. */
	efd = evl_attach_self(&quot;cruncher-%d&quot;, getpid());
	...
}
</code></pre>

<p>As a result of this call, you should see a new device appear into the
<em>/dev/evl/thread</em> hierarchy, e.g.:</p>

<pre><code>$ ls -l /dev/evl/thread
total 0
crw-rw----    1 root     root      246,   1 Jan  1  1970 clone
crw-rw----    1 root     root      246,   1 Jan  1  1970 cruncher-2712
</code></pre>

<ol>
<li><p>You can revert the attachment to EVL at any time by calling
<a href="/core/user-api/thread/#evl_detach_self"><code>evl_detach_self()</code></a> from the context
of the thread to detach.</p></li>

<li><p>Closing all the file descriptors referring to an EVL thread is not
enough to drop its attachment to the EVL core. It merely prevents to
submit any further request for the original thread via calls taking
file descriptors. You would still have to call
<a href="/core/user-api/thread/#evl_detach_self"><code>evl_detach_self()</code></a> from
the context of this thread to fully detach it.</p></li>

<li><p>If a valid file descriptor is still referring to a detached thread,
or after the thread has exited, any request submitted for that thread
using such <em>fd</em> would receive -ESTALE.</p></li>

<li><p>An EVL thread which exits is automatically detached from the EVL
core, you don&rsquo;t have to call <a href="/core/user-api/thread/#evl_detach_self"><code>evl_detach_self()</code></a>
explicitly before exiting your thread.</p></li>

<li><p>The EVL core drops the kernel resources attached to a thread once
it has detached itself or has exited, and only after all the file
descriptors referring to that thread have been closed.</p></li>

<li><p>The EVL library sets the O_CLOEXEC flag on the file descriptor
referring to the newly attached thread before returning from
<code>evl_attach_self()</code>.</p></li>
</ol>

<hr />

<div class="proto"><a name="evl_detach_self"></a>
int evl_detach_self(void)
</div>


<p><code>evl_detach_self()</code> reverts the action of <a href="/core/user-api/thread/#evl_attach_self"><code>evl_attach_self()</code></a>,
detaching the calling thread from the EVL core. Once this operation
has succeeded, the current thread cannot submit EVL requests
anymore. This call returns zero on success, or a negated error code if
something went wrong:</p>

<p>-EPERM      The current thread is not attached to the EVL core.</p>

<pre><code>#include &lt;evl/thread.h&gt;

static void *byte_crunching_thread(void *arg)
{
	int efd;

	/* Attach the current thread to the EVL core. */
	efd = evl_attach_self(&quot;cruncher-%d&quot;, getpid());
	...
	/* Then detach it. */
	evl_detach_self();
	...
}
</code></pre>

<ol>
<li><p>You can re-attach the detached thread to EVL at any time by calling
<a href="/core/user-api/thread/#evl_attach_self"><code>evl_attach_self()</code></a> again.</p></li>

<li><p>If a valid file descriptor is still referring to a detached thread,
or after the thread has exited, any request submitted for that thread
using such descriptor would receive -ESTALE.</p></li>

<li><p>An EVL thread which exits is automatically detached from the EVL
core, you don&rsquo;t have to call <code>evl_detach_self()</code> explicitly before
exiting your thread.</p></li>

<li><p>The EVL core drops the kernel resources attached to a thread once
it has detached itself or has exited, and only after all the file
descriptors referring to that thread have been closed.</p></li>
</ol>

<hr />

<div class="proto"><a name="evl_get_self"></a>
int evl_get_self(void)
</div>


<p><code>evl_get_self()</code> returns the file descriptor obtained for the current
thread after a successful call to <a href="/core/user-api/thread/#evl_attach_self"><code>evl_attach_self()</code></a>.  You may use
this <em>fd</em> to submit requests for the current thread in other calls
from the EVL library which ask for a thread file descriptor.  This
call returns a valid file descriptor referring to the caller on
success, or a negated error code if something went wrong:</p>

<p>-EPERM      The current thread is not attached to the EVL core.</p>

<pre><code>#include &lt;evl/thread.h&gt;

static void get_caller_info(void)
{
	struct evl_thread_state statebuf;
	int efd, ret;

	/* Fetch the current thread's _fd_. */
	efd = evl_get_self();
	...
	/* Retrieve the caller's state information. */
	ret = evl_get_state(efd, &amp;statebuf);
	...
}
</code></pre>

<p><code>evl_get_self()</code> will fail after a call to <a href="/core/user-api/thread/#evl_detach_self"><code>evl_detach_self()</code></a>.</p>

<hr />

<div class="proto"><a name="evl_attach_self"></a>
int evl_switch_oob(void)
</div>


<p>Applications are unlikely to ever use this call explicitly: it
switches the calling thread to the out-of-band <a href="/dovetail/pipeline/#two-stage-pipeline">execution
stage</a>, for running under EVL&rsquo;s supervision which ensures real-time
behaviour. Any EVL service which requires it will enforce such switch
if and when required automatically, so in most cases there should be
no point in dealing with this manually in applications.</p>

<p><code>evl_switch_oob()</code> is defined for the rare circumstances where some
high-level API based on the EVL core library might have to enforce a
particular execution stage, based on a deep knowledge of how EVL works
internally. Entering a syscall-free section of code for which the
out-of-band mode needs to be guaranteed on entry would be the only
valid reason to call <code>evl_switch_oob()</code>.  This call returns zero on
success, or a negated error code if something went wrong:</p>

<p>-EPERM      The current thread is not attached to the EVL core.</p>

<div class="notices warning" ><p>Forcing the current execution stage between in-band and out-of-band
stages is a heavyweight operation: this entails two thread context
switches both ways, as the switching thread is offloaded to the
opposite scheduler. You really don&rsquo;t want to force this explicitly
unless you definitely have to and fully understand the implications of
it runtime-wise. Bottom line is that <strong>calling a main kernel service
from within a time-critical code is a clear indication that something
is wrong</strong> in such code. This invalidates the reason why a
time-critical code would need to switch back to out-of-band mode
eagerly.</p>
</div>


<hr />

<div class="proto"><a name="evl_switch_inband"></a>
int evl_switch_inband(void)
</div>


<p>Applications are unlikely to ever use this call explicitly: it
switches the calling thread to the in-band <a href="/dovetail/pipeline/#two-stage-pipeline">execution stage</a>, for running
under the main kernel supervision. Any EVL thread which issues a
system call to the main kernel will be switched to the in-band context
automatically, so in most cases there should be no point in dealing
with this manually in applications.</p>

<p><code>evl_switch_inband()</code> is defined for the rare circumstances where some
high-level API based on the EVL core library might have to enforce a
particular execution stage, based on a deep knowledge of how EVL works
internally. Entering a syscall-free section of code for which the
in-band mode needs to be guaranteed on entry would be the only valid
reason to call <code>evl_switch_inband()</code>.  This call returns zero on
success, or a negated error code if something went wrong:</p>

<p>-EPERM      The current thread is not attached to the EVL core.</p>

<div class="notices warning" ><p>Forcing the current execution stage between in-band and out-of-band
stages is a heavyweight operation: this entails two thread context
switches both ways, as the switching thread is offloaded to the
opposite scheduler. You really don&rsquo;t want to force this explicitly
unless you definitely have to and fully understand the implications of
it runtime-wise. Bottom line is that <strong>switching the execution stage
to in-band from within a time-critical code is a clear indication that
something is wrong</strong> in such code.</p>
</div>


<hr />

<div class="proto"><a name="evl_set_schedattr"></a>
int evl_set_schedattr(int efd, const struct evl_sched_attrs *attrs)
</div>


<p>This call changes the scheduling attributes for the thread referred to
by <em>efd</em> in the EVL core.</p>

<p><li><i>efd</i><p>A file descriptor referring to the target thread, as returned by
<code>evl_attach_self()</code>, <code>evl_get_self()</code>, or opening a thread
element device in <em>/dev/evl/thread</em> using <code>open(2)</code>.</p>
</li></p>


<p><li><i>attrs</i><p>A structure defining the new set of attributes, which depends
on the scheduling policy mentioned in
<code>attrs-&gt;sched_policy</code>. EVL currently implement the following
policies:</p>
</li></p>


<ul>
<li><p><a href="/core/user-api/scheduling/#SCHED_FIFO">SCHED_FIFO</a>, which is the
common first-in, first-out real-time policy.</p></li>

<li><p><a href="/core/user-api/scheduling/#SCHED_RR">SCHED_RR</a>, defining a real-time, round-robin policy in which each member
of the class is allotted an individual time quantum before the CPU
is given to the next thread.</p></li>

<li><p><a href="/core/user-api/scheduling/#SCHED_QUOTA">SCHED_QUOTA</a>, which
enforces a limitation on the CPU consumption of threads over a fixed
period of time, known as the global quota period. Threads undergoing
this policy are pooled in groups, with each group being given a
share of the period.</p></li>

<li><p><a href="/core/user-api/scheduling/#SCHED_WEAK">SCHED_WEAK</a>, which is a
<em>non real-time</em> policy allowing its members to run in-band most of
the time, while retaining the ability to request EVL services, at
the expense of briefly switching to the out-of-band execution stage
on demand.</p></li>
</ul>

<p><code>evl_sched_attrs()</code> returns zero on success, otherwise a negated error
code is returned:</p>

<p>-EBADF      <em>efd</em> is not a valid thread descriptor.</p>

<p>-EINVAL     Some of the parameters in <em>attrs</em> are wrong. Check
        <code>attrs-&gt;sched_policy</code>, and the policy-specific
        information may EVL expect for more.</p>

<p>-ESTALE <em>efd</em> refers to a stale thread, see these <a href="/core/user-api/thread/#detached-thread-notes">notes</a>.</p>

<pre><code>#include &lt;evl/thread.h&gt;

int change_self_schedparams(void)
{
	struct evl_sched_attrs attrs;
	int ret;

	attrs.sched_policy = SCHED_FIFO;
	attrs.sched_priority = 90;
	return evl_set_schedattr(evl_get_self(), &amp;attrs);
}
</code></pre>

<p><code>evl_set_schedattr()</code> immediately changes the scheduling attributes
the EVL core uses for the target thread when it runs in out-of-band
context. Later on, the next time such thread transitions from
out-of-band to in-band context, the main kernel will apply an
extrapolated version of those changes to its own scheduler as well.</p>

<p>The extrapolation of the out-of-band scheduling attributes passed to
<code>evl_set_schedattr()</code> to the in-band ones applied by the mainline
kernel works as follows:</p>

<table>
<thead>
<tr>
<th>out-of-band policy</th>
<th>in-band policy</th>
</tr>
</thead>

<tbody>
<tr>
<td>SCHED_FIFO, prio</td>
<td>SCHED_FIFO, prio</td>
</tr>

<tr>
<td>SCHED_RR, prio</td>
<td>SCHED_FIFO, prio</td>
</tr>

<tr>
<td>SCHED_WEAK, prio &gt; 0</td>
<td>SCHED_FIFO, prio</td>
</tr>

<tr>
<td>SCHED_WEAK, prio == 0</td>
<td>SCHED_OTHER</td>
</tr>
</tbody>
</table>

<div class="notices warning" ><p>Calling <code>pthread_setschedparam()</code> from the C library does not affect
the scheduling attributes of an EVL thread. It only affects the
scheduling parameters of such thread from the standpoint of the main
kernel. Because the C library may cache the current scheduling
attributes for the in-band context of a thread - <em>glibc</em> does so
typically - the cached value may not reflect the actual scheduling
attributes of the thread after this call.</p>
</div>


<hr />

<div class="proto"><a name="evl_get_schedattr"></a>
int evl_get_schedattr(int efd, struct evl_sched_attrs *attrs)
</div>


<hr />

<div class="proto"><a name="evl_get_state"></a>
int evl_get_state(int efd, struct evl_thread_state *statebuf)
</div>


<hr />

<h3 id="can-evl-threads-run-in-kernel-space">Can EVL threads run in kernel space?</h3>

<p>Yes. Drivers may create kernel-based EVL threads backed by regular
<em>kthreads</em>, using EVL&rsquo;s <a href="/core/kernel-api/">kernel API</a>. The attachment phase is hidden
inside the API call starting the EVL kthread in this case. Most of the
notions explained in this document apply to them too, except that
there is no system call interface between the EVL core and the
kthread. <strong>So nothing can prevent EVL kthreads from calling the main
kernel services from the wrong context.</strong></p>

<h3 id="where-do-thread-devices-live">Where do thread devices live?</h3>

<p>Each time a new thread element is created, it appears into the
<em>/dev/evl/thread</em> hierarchy, e.g.:</p>

<pre><code>$ ls -l /dev/evl/threads
total 0
crw-rw----    1 root     root      246,   1 Jan  1  1970 clone
crw-rw----    1 root     root      244,   0 Mar  1 11:26 rtk1@0:1682
crw-rw----    1 root     root      244,  18 Mar  1 11:26 rtk1@1:1682
crw-rw----    1 root     root      244,  36 Mar  1 11:26 rtk1@2:1682
crw-rw----    1 root     root      244,  54 Mar  1 11:26 rtk1@3:1682
crw-rw----    1 root     root      244,   1 Mar  1 11:26 rtk2@0:1682
crw-rw----    1 root     root      244,  19 Mar  1 11:26 rtk2@1:1682
crw-rw----    1 root     root      244,  37 Mar  1 11:26 rtk2@2:1682
crw-rw----    1 root     root      244,  55 Mar  1 11:26 rtk2@3:1682
                           (snip)
crw-rw----    1 root     root      244,   9 Mar  1 11:26 rtus_ufps0-10:1682
crw-rw----    1 root     root      244,   8 Mar  1 11:26 rtus_ufps0-9:1682
crw-rw----    1 root     root      244,  27 Mar  1 11:26 rtus_ufps1-10:1682
crw-rw----    1 root     root      244,  26 Mar  1 11:26 rtus_ufps1-9:1682
crw-rw----    1 root     root      244,  45 Mar  1 11:26 rtus_ufps2-10:1682
crw-rw----    1 root     root      244,  44 Mar  1 11:26 rtus_ufps2-9:1682
crw-rw----    1 root     root      244,  63 Mar  1 11:26 rtus_ufps3-10:1682
crw-rw----    1 root     root      244,  62 Mar  1 11:26 rtus_ufps3-9:1682
</code></pre>

<div class="notices info" ><p>The <em>clone</em> file is a special device which allows the EVL library to
request the creation of a thread element. <em>This is for internal use only</em>.</p>
</div>


<h3 id="how-to-reach-a-remote-evl-thread">How to reach a remote EVL thread?</h3>

<p>If you need to submit requests for an EVL thread which belongs to a
different process, you only need to open the device file representing
this element in <em>/dev/evl/threads</em>, then use the file descriptor
just obtained in the thread-related request you want to send it. For
instance, we could change the scheduling parameters of an EVL kernel
thread named rtk1@3:1682 from a companion application in userland as
follows:</p>

<pre><code>	struct evl_sched_attrs attrs;
	int efd, ret;

 	efd = open(&quot;/dev/evl/thread/rtk1@3:1682&quot;, O_RDWR);
	/* skipping checks */

	attrs.sched_policy = SCHED_FIFO;
	attrs.sched_priority = 90;
	ret = evl_set_schedattr(efd, &amp;attrs);
	/* skipping checks */
</code></pre>

<h3 id="where-to-look-for-thread-information">Where to look for thread information?</h3>

<p>Since every element is backed by a regular character device, the place
to look for thread attributes is in the /sysfs hierarchy, where such
device is living. For instance, we can have a look at the attributes
exported by the sampling thread of EVL&rsquo;s <em>latmus</em> utility like this:</p>

<pre><code>cd /sys/devices/virtual/thread/lat-sampler:2136
# ls -l
total 0
-r--r--r--    1 root     root          4096 Mar  1 12:01 pid
-r--r--r--    1 root     root          4096 Mar  1 12:01 sched
-r--r--r--    1 root     root          4096 Mar  1 12:01 state
-r--r--r--    1 root     root          4096 Mar  1 12:01 stats
-r--r--r--    1 root     root          4096 Mar  1 12:01 timeout

# cat pid sched state stats timeout
2140
0 90 90 rt
0x8002
1 311156 311175 46999122352 0
0
</code></pre>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/core/user-api/" title="The EVL library"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/core/user-api/mutex/" title="Mutex" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1554201814"></script>
    <script src="/js/perfect-scrollbar.min.js?1554201814"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1554201814"></script>
    <script src="/js/jquery.sticky.js?1554201814"></script>
    <script src="/js/featherlight.min.js?1554201814"></script>
    <script src="/js/html5shiv-printshiv.min.js?1554201814"></script>
    <script src="/js/highlight.pack.js?1554201814"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1554201814"></script>
    <script src="/js/learn.js?1554201814"></script>
    <script src="/js/hugo-learn.js?1554201814"></script>

    <link href="/mermaid/mermaid.css?1554201814" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1554201814"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
  </body>
</html>
