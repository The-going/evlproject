<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.31" />
    <meta name="description" content="Dovetail co-kernel interface for Linux">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Optimistic Interrupt Protection :: Dovetail</title>
    
    
    <link href="/css/nucleus.css?1532462079" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1532462079" rel="stylesheet">
    <link href="/css/hybrid.css?1532462079" rel="stylesheet">
    <link href="/css/featherlight.min.css?1532462079" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1532462079" rel="stylesheet">
    <link href="/css/auto-complete.css?1532462079" rel="stylesheet">
    <link href="/css/theme.css?1532462079" rel="stylesheet">
    <link href="/css/hugo-theme.css?1532462079" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1532462079" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1532462079"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/pipeline/optimistic/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/logo.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1532462079"></script>
<script type="text/javascript" src="/js/auto-complete.js?1532462079"></script>
<script type="text/javascript">
    
        var baseurl = '\/';
    
</script>
<script type="text/javascript" src="/js/search.js?1532462079"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/pipeline/" title="Interrupt pipeline" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/">
          Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item active">
        <a href="/pipeline/optimistic/">
        Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/porting/" title="Porting" class="dd-item 
        
        
        
        ">
      <a href="/pipeline/porting/">
          Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item ">
        <a href="/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item ">
        <a href="/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/usage/" title="Usage" class="dd-item 
        
        
        
        ">
      <a href="/pipeline/usage/">
          Usage
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_push/" title="Installing the head stage" class="dd-item ">
        <a href="/pipeline/usage/stage_push/">
        Head stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_stop/" title="Pipeline Stop" class="dd-item ">
        <a href="/pipeline/usage/pipeline_stop/">
        Pipeline Stop
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/pipeline/rulesofthumb/">
        Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/altsched/" title="Alternate Task Control" class="dd-item 
        
        
        
        ">
      <a href="/altsched/">
          Alternate Task Control
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contributing/" title="Contributing to Dovetail" class="dd-item 
        
        
        
        ">
      <a href="/contributing/">
          Contributing
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/status/" title="Status" class="dd-item 
        
        
        
        ">
      <a href="/status/">
          Status
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/about/" title="About this site" class="dd-item 
        
        
        
        ">
      <a href="/about/">
          About
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Introduction</a> > <a href='/pipeline/'>Interrupt pipeline</a> > Optimistic Interrupt Protection
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#virtual-i-flag">Virtual interrupt disabling</a></li>
<li><a href="#interrupt-deferral-for-the-root-stage">Interrupt deferral for the <em>root stage</em></a></li>
<li><a href="#no-inband-reentry">All interrupts are (seemingly) NMIs</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Optimistic Interrupt Protection</h1>
          

        




<p>Predictable response time of out-of-band handlers to IRQ receipts
requires the in-band kernel work not to be allowed to delay them by
masking interrupts in the CPU.</p>

<p>However, critical sections delimited this way by the in-band code must
still be enforced for the <em>root stage</em>, so that system integrity is
not at risk. This means that although out-of-band IRQ handlers may run
at any time while the <em>head stage</em> is accepting interrupts, in-band
IRQ handlers should be allowed to run only when the root stage is
accepting interrupts too. So we need to decouple the interrupt masking
and delivery logic which applies to the head stage from the one in
effect on the root stage, by implementing a dual interrupt control.</p>

<h2 id="virtual-i-flag">Virtual interrupt disabling</h2>

<p>To this end, a software logic managing a virtual interrupt disable
flag is introduced by the interrupt pipeline between the hardware and
the generic IRQ management layer. This logic can mask IRQs from the
perspective of the in-band kernel work when <code>local_irq_save()</code>,
<code>local_irq_disable()</code> or any lock-controlled masking operations like
<code>spin_lock_irqsave()</code> is called, while still accepting IRQs from the
CPU for immediate delivery to out-of-band handlers.</p>

<p>When a real IRQ arrives while interrupts are virtually masked, the
event is logged for the receiving CPU, kept there until the virtual
interrupt disable flag is cleared at which point it is dispatched as
if it just happened. The principle of deferring interrupt delivery
based on a software flag coupled to an event log has been originally
described as <em>Optimistic interrupt protection</em> in <a href="https://www.usenix.org/legacy/publications/library/proceedings/micro93/full_papers/stodolsky.txt">this
paper</a>.
It was originally intended as a low-overhead technique for
manipulating the processor interrupt state, reducing the cost of
interrupt masking for the common case of absence of interrupts.</p>

<p>In Dovetail&rsquo;s two-stage pipeline, the head stage protects from
interrupts by disabling them in the CPU&rsquo;s status register as usual,
while the root stage disables interrupts only virtually. A stage for
which interrupts are disabled is said to be <em>stalled</em>. Conversely,
<em>unstalling</em> a stage means re-enabling interrupts for it.</p>

<div class="notices warning" ><p>Obviously, stalling the head stage implicitly means disabling
further IRQ receipts for the root stage too.</p>
</div>


<h2 id="interrupt-deferral-for-the-root-stage">Interrupt deferral for the <em>root stage</em></h2>

<p>When the root stage is stalled because the virtual interrupt disable
flag is set, any IRQ event which was not immediately delivered to the
<em>head stage</em> is recorded into a per-CPU log, postponing delivery to
the in-band kernel handler.</p>

<p>Such delivery is deferred until the in-band kernel code clears the
virtual interrupt disable flag by calling <code>local_irq_enable()</code> or any
of its variants, which unstalls the root stage. When this happens, the
interrupt state is resynchronized by playing the log, firing the
in-band handlers for which an IRQ event is pending.</p>

<pre><code class="language-markdown">   /* Both stages unstalled on entry */
   local_irq_save(flags);
   &lt;IRQx received: no out-of-band handler&gt;
       (pipeline logs IRQx event)
   ...
   local_irq_restore(flags);
       (pipeline plays IRQx event)
            handle_IRQx_interrupt();
</code></pre>

<p>If the root stage is unstalled at the time of the IRQ receipt, the
in-band handler is immediately invoked, just like with the
non-pipelined IRQ model.</p>

<h2 id="no-inband-reentry">All interrupts are (seemingly) NMIs</h2>

<p>From the standpoint of the in-band kernel code (i.e. the one running
over the <em>root</em> interrupt stage) , the interrupt pipelining logic
virtually turns all device IRQs into NMIs, for running out-of-band
handlers.</p>

<p>For this reason, out-of-band code may generally <strong>NOT</strong> re-enter
in-band code, for preventing creepy situations like this one:</p>

<pre><code class="language-markdown">   /* in-band context */
   spin_lock_irqsave(&amp;lock, flags);
      &lt;IRQx received: out-of-band handler installed&gt;
         handle_oob_event();
            /* attempted re-entry to in-band from out-of-band. */
            in_band_routine();
               spin_lock_irqsave(&amp;lock, flags);
               &lt;DEADLOCK&gt;
               ...
            ...
         ...
   ...
   spin_unlock irqrestore(&amp;lock, flags);
</code></pre>

<p>Even in absence of an attempt to get a spinlock recursively, the outer
in-band code in the example above is entitled to assume that no access
race can occur on the current CPU while interrupts are
masked. Re-entering in-band code from an out-of-band handler would
invalidate this assumption.</p>

<p>In rare cases, we may need to fix up the in-band kernel routines in
order to allow out-of-band handlers to call them. Typically, atomic
helpers are such routines, which serialize in-band and out-of-band
callers.</p>

<p>For all other cases, the <a href="/pipeline/porting/irqflow/#irq-work">IRQ work API</a> is available for scheduling
the execution of a routine from the head stage, which will be invoked
later from the root stage as soon as it gets back in control on the
current CPU.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/pipeline/" title="Interrupt pipeline"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/pipeline/porting/" title="Porting" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1532462079"></script>
    <script src="/js/perfect-scrollbar.min.js?1532462079"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1532462079"></script>
    <script src="/js/jquery.sticky.js?1532462079"></script>
    <script src="/js/featherlight.min.js?1532462079"></script>
    <script src="/js/html5shiv-printshiv.min.js?1532462079"></script>
    <script src="/js/highlight.pack.js?1532462079"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1532462079"></script>
    <script src="/js/learn.js?1532462079"></script>
    <script src="/js/hugo-learn.js?1532462079"></script>

    <link href="/mermaid/mermaid.css?1532462079" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1532462079"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

