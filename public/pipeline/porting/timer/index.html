<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.31" />
    <meta name="description" content="Dovetail co-kernel interface for Linux">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Timer management :: Dovetail</title>
    
    
    <link href="/css/nucleus.css?1530465323" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1530465323" rel="stylesheet">
    <link href="/css/hybrid.css?1530465323" rel="stylesheet">
    <link href="/css/featherlight.min.css?1530465323" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1530465323" rel="stylesheet">
    <link href="/css/auto-complete.css?1530465323" rel="stylesheet">
    <link href="/css/theme.css?1530465323" rel="stylesheet">
    <link href="/css/hugo-theme.css?1530465323" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1530465323" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1530465323"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/pipeline/porting/timer/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <img src="/images/logo.png">

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1530465323"></script>
<script type="text/javascript" src="/js/auto-complete.js?1530465323"></script>
<script type="text/javascript">
    
        var baseurl = '\/';
    
</script>
<script type="text/javascript" src="/js/search.js?1530465323"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/pipeline/" title="Interrupt pipeline" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/">
          Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/pipeline/optimistic/">
        Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/usage/" title="Usage" class="dd-item 
        
        
        
        ">
      <a href="/pipeline/usage/">
          Usage
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_push/" title="Installing the head stage" class="dd-item ">
        <a href="/pipeline/usage/stage_push/">
        Head stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_stop/" title="Pipeline Stop" class="dd-item ">
        <a href="/pipeline/usage/pipeline_stop/">
        Pipeline Stop
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/porting/" title="Porting" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/porting/">
          Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/timer/" title="Timer management" class="dd-item active">
        <a href="/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/locking/" title="Locking" class="dd-item ">
        <a href="/pipeline/porting/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/pipeline/rulesofthumb/">
        Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/altsched/" title="Shared Task Control" class="dd-item 
        
        
        
        ">
      <a href="/altsched/">
          Shared Task Control
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Introduction</a> > <a href='/pipeline/'>Interrupt pipeline</a> > <a href='/pipeline/porting/'>Porting</a> > Timer management
          
         
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#proxy-tick-device">Proxy tick device</a></li>
<li><a href="#changes-to-the-clock-chip-devices">Changes to the clock chip devices</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Timer management</h1>
          

        




<h2 id="proxy-tick-device">Proxy tick device</h2>

<p>The proxy tick device is a synthetic clock event device for handing
over the control of the hardware tick device to a high-precision,
out-of-band timing logic, <a href="/#dual-kernel-upsides">which does not run into delays</a> caused by the in-band kernel code.</p>

<p>With this proxy in place, any out-of-band code can gain control over
the timer hardware for carrying out its own timing duties. In the same
move, it is required to honor the timing requests received from the
in-band timer core (i.e. hrtimers) since the latter won&rsquo;t be able to
program timer events directly into the hardware while the proxy is
active.</p>

<p>In other words, the proxy tick device shares the functionality of the
actual device between the in-band and out-of-band contexts, with only
the latter actually programming the hardware.</p>

<h2 id="changes-to-the-clock-chip-devices">Changes to the clock chip devices</h2>

<p>The proxy device stacks over a real clock chip device, controlling
it. Clock chips which may be controlled by the proxy tick device need
their drivers to be specifically adapted for such use, as follows:</p>

<ul>
<li><p><code>clockevents_handle_event()</code> must be used to invoke the event
handler from the interrupt handler, instead of dereferencing <code>struct
clock_event_device::event_handler</code> directly.</p></li>

<li><p><code>struct clock_event_device::irq</code> must be properly set to the actual
IRQ number signaling an event from this device.</p></li>

<li><p><code>struct clock_event_device::features</code> must include
<code>CLOCK_EVT_FEAT_PIPELINE</code>.</p></li>

<li><p><code>__IRQF_TIMER</code> must be set for the action handler of the timer
device interrupt.</p></li>
</ul>

<blockquote>
<p>Adapting the ARM architected timer driver to out-of-band timing</p>
</blockquote>

<pre><code>--- a/drivers/clocksource/arm_arch_timer.c
+++ b/drivers/clocksource/arm_arch_timer.c
@@ -585,7 +585,7 @@ static __always_inline irqreturn_t timer_handler(const int access,
 	if (ctrl &amp; ARCH_TIMER_CTRL_IT_STAT) {
 		ctrl |= ARCH_TIMER_CTRL_IT_MASK;
 		arch_timer_reg_write(access, ARCH_TIMER_REG_CTRL, ctrl, evt);
-		evt-&gt;event_handler(evt);
+		clockevents_handle_event(evt);
 		return IRQ_HANDLED;
 	}
 
@@ -704,7 +704,7 @@ static int arch_timer_set_next_event_phys_mem(unsigned long evt,
 static void __arch_timer_setup(unsigned type,
 			       struct clock_event_device *clk)
 {
-	clk-&gt;features = CLOCK_EVT_FEAT_ONESHOT;
+	clk-&gt;features = CLOCK_EVT_FEAT_ONESHOT | CLOCK_EVT_FEAT_PIPELINE;
 
 	if (type == ARCH_TIMER_TYPE_CP15) {
 		if (arch_timer_c3stop)
</code></pre>

<div class="notices note" ><p>Only oneshot-capable clock event devices can be shared via the proxy tick device.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/pipeline/porting/arch/" title="Architecture-specific bits"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/pipeline/porting/atomic/" title="Atomic operations" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1530465323"></script>
    <script src="/js/perfect-scrollbar.min.js?1530465323"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1530465323"></script>
    <script src="/js/jquery.sticky.js?1530465323"></script>
    <script src="/js/featherlight.min.js?1530465323"></script>
    <script src="/js/html5shiv-printshiv.min.js?1530465323"></script>
    <script src="/js/highlight.pack.js?1530465323"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1530465323"></script>
    <script src="/js/learn.js?1530465323"></script>
    <script src="/js/hugo-learn.js?1530465323"></script>

    <link href="/mermaid/mermaid.css?1530465323" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1530465323"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

