<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.31" />
    <meta name="description" content="Dovetail co-kernel interface for Linux">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Raw printk support :: Dovetail</title>
    
    
    <link href="/css/nucleus.css?1535190895" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1535190895" rel="stylesheet">
    <link href="/css/hybrid.css?1535190895" rel="stylesheet">
    <link href="/css/featherlight.min.css?1535190895" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1535190895" rel="stylesheet">
    <link href="/css/auto-complete.css?1535190895" rel="stylesheet">
    <link href="/css/theme.css?1535190895" rel="stylesheet">
    <link href="/css/hugo-theme.css?1535190895" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1535190895" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1535190895"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/pipeline/porting/rawprintk/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/logo.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1535190895"></script>
<script type="text/javascript" src="/js/auto-complete.js?1535190895"></script>
<script type="text/javascript">
    
        var baseurl = '\/';
    
</script>
<script type="text/javascript" src="/js/search.js?1535190895"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/pipeline/" title="Interrupt pipeline" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/">
          Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/pipeline/optimistic/">
        Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/porting/" title="Porting" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/porting/">
          Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item active">
        <a href="/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item ">
        <a href="/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/usage/" title="Usage" class="dd-item 
        
        
        
        ">
      <a href="/pipeline/usage/">
          Usage
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_push/" title="Installing the head stage" class="dd-item ">
        <a href="/pipeline/usage/stage_push/">
        Head stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/pipeline/rulesofthumb/">
        Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/altsched/" title="Alternate Task Control" class="dd-item 
        
        
        
        ">
      <a href="/altsched/">
          Alternate Task Control
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contributing/" title="Contributing to Dovetail" class="dd-item 
        
        
        
        ">
      <a href="/contributing/">
          Contributing
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/status/" title="Status" class="dd-item 
        
        
        
        ">
      <a href="/status/">
          Status
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/about/" title="About this site" class="dd-item 
        
        
        
        ">
      <a href="/about/">
          About
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Introduction</a> > <a href='/pipeline/'>Interrupt pipeline</a> > <a href='/pipeline/porting/'>Porting</a> > Raw printk support
          
         
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#arm-specific-raw-console-driver">ARM-specific raw console driver</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Raw printk support</h1>
          

        




<p>Unless you are lucky enough to have an ICE for debugging hard issues
involving out-of-band contexts, you might have to resort to basic
printk-style debugging over a serial line. If so, do <strong>NOT</strong> rely on
the regular <em>printk()</em> routine for this, this won&rsquo;t work in most
cases, potentially adding even more sources of lockups to the whole
gloomy picture. Although the <em>printk()</em> machinery can be used from
out-of-band context, the output is deferred until the root stage gets
back in control, which means that:</p>

<ul>
<li><p>you can&rsquo;t reliably trace out-of-band code on the spot, deferred
output issued from an out-of-band context, or from a section of code
running with interrupts disabled in the CPU may appear after
subsequent in-band messages under some circumstances, due to a
buffering effect.</p></li>

<li><p>if the debug traces are sent at high pace (e.g. from an out-of-band
IRQ handler every few hundreds of microseconds), the machine is
likely to come to a stall due to the massive output the heavy
<em>printk()</em> machinery would have to handle, leading to an apparent
lockup.</p></li>
</ul>

<p>The only sane option for printk-like debugging in demanding
out-of-band context is using the <em>raw_printk()</em> routine for issuing
raw debug messages to a serial console, so that you may get some
sensible feedback for understanding what is going on with the
execution flow. This feature should be enabled by turning on
<code>CONFIG_RAW_PRINTK</code>, otherwise all output sent to <em>raw_printk()</em> is
discarded.</p>

<p>Because a regular (in-band) serial console driver won&rsquo;t be usable from
out-of-band context, enabling raw printk support requires adapting the
serial console driver your platform is using, by adding a raw write
handler to the console description. Just like the regular <em>write()</em>
handler, the raw output handler receives a console pointer, the
character string to output and its length as parameters. This handler
should send the characters to the UART as quickly as possible, with
little to no preparation.</p>

<p>All output formatted by the generic <em>raw_printk()</em> routine is passed
to the raw write handler of the current serial console driver if
present. Calls to the raw output handler are serialized in
<em>raw_printk()</em> by holding a <a href="/pipeline/usage/locking/#new-spinlocks">hard spinlock</a>, which means that
interrupts are disabled in the CPU when running the handler.</p>

<div class="notices tip" ><p>A raw write handler is normally derived from the regular write handler
for the same serial console device, skipping any in-band locking
construct, only waiting for the bare minimum time for the output to
drain in the UART since we want to keep interrupt latency low.</p>
</div>


<blockquote>
<p>Adding RAW_PRINTK support to the AMBA PL011 serial driver</p>
</blockquote>

<pre><code>--- a/drivers/tty/serial/amba-pl011.c
+++ b/drivers/tty/serial/amba-pl011.c
@@ -2206,6 +2206,40 @@ static void pl011_console_putchar(struct uart_port *port, int ch)
 	pl011_write(ch, uap, REG_DR);
 }
 
+#ifdef CONFIG_RAW_PRINTK
+
+/*
+ * The uart clk stays on all along in the current implementation,
+ * despite what pl011_console_write() suggests, so for the time being,
+ * just emit the characters assuming the chip is clocked. If the clock
+ * ends up being turned off after writing, we may need to clk_enable()
+ * it at console setup, relying on the non-zero enable_count for
+ * keeping pl011_console_write() from disabling it.
+ */
+static void
+pl011_console_write_raw(struct console *co, const char *s, unsigned int count)
+{
+	struct uart_amba_port *uap = amba_ports[co-&gt;index];
+	unsigned int old_cr, new_cr, status;
+
+	old_cr = readw(uap-&gt;port.membase + UART011_CR);
+	new_cr = old_cr &amp; ~UART011_CR_CTSEN;
+	new_cr |= UART01x_CR_UARTEN | UART011_CR_TXE;
+	writew(new_cr, uap-&gt;port.membase + UART011_CR);
+
+	while (count-- &gt; 0) {
+		if (*s == '\n')
+			pl011_console_putchar(&amp;uap-&gt;port, '\r');
+		pl011_console_putchar(&amp;uap-&gt;port, *s++);
+	}
+	do
+		status = readw(uap-&gt;port.membase + UART01x_FR);
+	while (status &amp; UART01x_FR_BUSY);
+	writew(old_cr, uap-&gt;port.membase + UART011_CR);
+}
+
+#endif  /* !CONFIG_RAW_PRINTK */
+
 static void
 pl011_console_write(struct console *co, const char *s, unsigned int count)
 {
@@ -2406,6 +2440,9 @@ static struct console amba_console = {
 	.device		= uart_console_device,
 	.setup		= pl011_console_setup,
 	.match		= pl011_console_match,
+#ifdef CONFIG_RAW_PRINTK
+	.write_raw	= pl011_console_write_raw,
+#endif
 	.flags		= CON_PRINTBUFFER | CON_ANYTIME,
 	.index		= -1,
 	.data		= &amp;amba_reg,
</code></pre>

<h3 id="arm-specific-raw-console-driver">ARM-specific raw console driver</h3>

<p>The vanilla ARM kernel port already provides an UART-based raw output
routine called <em>printascii()</em> when <code>CONFIG_DEBUG_LL</code> is enabled,
provided the right debug UART channel is defined too
(<code>CONFIG_DEBUG_UART_xx</code>).</p>

<p>When <code>CONFIG_RAW_PRINTK</code> and <code>CONFIG_DEBUG_LL</code> are both defined in the
kernel configuration, the ARM implementation of Dovetail automatically
registers a special console device for emitting debug output (see
<em>arch/arm/kernel/raw_printk.c</em>), which redirects calls to its raw
write handler by <em>raw_printk()</em> to <em>printascii()</em>. In other words, if
<code>CONFIG_DEBUG_LL</code> already provides you with a functional debug output
channel, you don&rsquo;t need the active serial console driver to implement
a raw write handler for enabling <em>raw_printk()</em>, the raw console
device should handle <em>raw_printk()</em> requests just fine.</p>

<div class="notices warning" ><p>Enabling <code>CONFIG_DEBUG_LL</code> with a wrong UART debug channel is a common
cause of lockup at boot. You do want to make sure that the proper
<code>CONFIG_DEBUG_UART_xx</code> symbol matching your hardware is selected along
with <code>CONFIG_DEBUG_LL</code>.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/pipeline/porting/atomic/" title="Atomic operations"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/pipeline/porting/misc/" title="Misc" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1535190895"></script>
    <script src="/js/perfect-scrollbar.min.js?1535190895"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1535190895"></script>
    <script src="/js/jquery.sticky.js?1535190895"></script>
    <script src="/js/featherlight.min.js?1535190895"></script>
    <script src="/js/html5shiv-printshiv.min.js?1535190895"></script>
    <script src="/js/highlight.pack.js?1535190895"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1535190895"></script>
    <script src="/js/learn.js?1535190895"></script>
    <script src="/js/hugo-learn.js?1535190895"></script>

    <link href="/mermaid/mermaid.css?1535190895" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1535190895"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

