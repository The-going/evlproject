<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.31" />
    <meta name="description" content="Dovetail co-kernel interface for Linux">
<meta name="author" content="Philippe Gerum &lt;rpm@xenomai.org&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Developer&#39;s Notes :: Dovetail</title>
    
    
    <link href="/css/nucleus.css?1532619714" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1532619714" rel="stylesheet">
    <link href="/css/hybrid.css?1532619714" rel="stylesheet">
    <link href="/css/featherlight.min.css?1532619714" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1532619714" rel="stylesheet">
    <link href="/css/auto-complete.css?1532619714" rel="stylesheet">
    <link href="/css/theme.css?1532619714" rel="stylesheet">
    <link href="/css/hugo-theme.css?1532619714" rel="stylesheet">
    
      <link href="/css/theme-blue.css?1532619714" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1532619714"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/pipeline/porting/devnotes/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/images/logo.png"></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1532619714"></script>
<script type="text/javascript" src="/js/auto-complete.js?1532619714"></script>
<script type="text/javascript">
    
        var baseurl = '\/';
    
</script>
<script type="text/javascript" src="/js/search.js?1532619714"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/pipeline/" title="Interrupt pipeline" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/">
          Interrupt pipeline
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/optimistic/" title="Optimistic Interrupt Protection" class="dd-item ">
        <a href="/pipeline/optimistic/">
        Optimistic protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/porting/" title="Porting" class="dd-item 
        parent
        
        
        ">
      <a href="/pipeline/porting/">
          Porting
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/prerequisites/" title="Prerequisites" class="dd-item ">
        <a href="/pipeline/porting/prerequisites/">
        Prerequisites
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/irqflow/" title="Interrupt flow" class="dd-item ">
        <a href="/pipeline/porting/irqflow/">
        Interrupt flow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/arch/" title="Architecture-specific bits" class="dd-item ">
        <a href="/pipeline/porting/arch/">
        Architecture bits
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/timer/" title="Timer management" class="dd-item ">
        <a href="/pipeline/porting/timer/">
        Timer management
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/atomic/" title="Atomic operations" class="dd-item ">
        <a href="/pipeline/porting/atomic/">
        Atomic operations
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/rawprintk/" title="Raw printk support" class="dd-item ">
        <a href="/pipeline/porting/rawprintk/">
        Serial debugging
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/misc/" title="Misc" class="dd-item ">
        <a href="/pipeline/porting/misc/">
        Misc
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/porting/devnotes/" title="Developer&#39;s Notes" class="dd-item active">
        <a href="/pipeline/porting/devnotes/">
        Developer&#39;s Notes
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/pipeline/usage/" title="Usage" class="dd-item 
        
        
        
        ">
      <a href="/pipeline/usage/">
          Usage
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_push/" title="Installing the head stage" class="dd-item ">
        <a href="/pipeline/usage/stage_push/">
        Head stage installation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/irq_handling/" title="IRQ handling" class="dd-item ">
        <a href="/pipeline/usage/irq_handling/">
        IRQ handling
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/synthetic/" title="Synthetic IRQs" class="dd-item ">
        <a href="/pipeline/usage/synthetic/">
        Synthetic IRQs
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/pipeline_inject/" title="IRQ injection" class="dd-item ">
        <a href="/pipeline/usage/pipeline_inject/">
        IRQ injection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/stage_escalation/" title="Stage escalation" class="dd-item ">
        <a href="/pipeline/usage/stage_escalation/">
        Stage escalation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/interrupt_protection/" title="Interrupt Protection" class="dd-item ">
        <a href="/pipeline/usage/interrupt_protection/">
        Interrupt Protection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/usage/locking/" title="Locking" class="dd-item ">
        <a href="/pipeline/usage/locking/">
        Locking
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pipeline/rulesofthumb/" title="Rules Of Thumb" class="dd-item ">
        <a href="/pipeline/rulesofthumb/">
        Rules Of Thumb
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/altsched/" title="Alternate Task Control" class="dd-item 
        
        
        
        ">
      <a href="/altsched/">
          Alternate Task Control
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/contributing/" title="Contributing to Dovetail" class="dd-item 
        
        
        
        ">
      <a href="/contributing/">
          Contributing
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/status/" title="Status" class="dd-item 
        
        
        
        ">
      <a href="/status/">
          Status
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/about/" title="About this site" class="dd-item 
        
        
        
        ">
      <a href="/about/">
          About
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Introduction</a> > <a href='/pipeline/'>Interrupt pipeline</a> > <a href='/pipeline/porting/'>Porting</a> > Developer's Notes
          
         
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#generic">Generic</a>
<ul>
<li><a href="#fundamentally-preemption-safe-contexts">Fundamentally preemption-safe contexts</a></li>
<li><a href="#checking-for-out-of-band-interrupt-property">Checking for out-of-band interrupt property</a></li>
<li><a href="#stop-machine-hard-disables-interrupts">stop_machine() hard disables interrupts</a></li>
</ul></li>
<li><a href="#arm">ARM</a>
<ul>
<li><a href="#context-assumption-with-outer-l2-cache">Context assumption with outer L2 cache</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Developer&#39;s Notes</h1>
          

        




<h2 id="generic">Generic</h2>

<h3 id="fundamentally-preemption-safe-contexts">Fundamentally preemption-safe contexts</h3>

<p>Over a few contexts, we may traverse code using unprotected,
preemption-sensitive accessors such as <code>percpu()</code> without disabling
preemption specifically, because either one condition is true;</p>

<ul>
<li><p>if <code>preempt_count()</code> bears either of the <code>PIPELINE_MASK</code> or
<code>STAGE_MASK</code> bits, which turns preemption off, therefore CPU
migration cannot happen (<code>debug_smp_processor_id()</code> and preempt
checks in <code>percpu</code> accessors would detect such context properly
too).</p></li>

<li><p>if we are running over the context of the root stage&rsquo;s event log
syncer (<code>irq_stage_sync_current()</code>) playing a deferred interrupt, in
which case the virtual interrupt disable bit is set, so no CPU
migration may occur either.</p></li>
</ul>

<p>For instance, the following contexts qualify:</p>

<ul>
<li><p><code>clockevents_handle_event()</code>, which should either be called from the
head stage - therefore <code>STAGE_MASK</code> is set - when the <a href="/pipeline/porting/timer/#proxy-tick-logic">proxy tick
device is active</a> on the CPU,
and/or from the root stage playing a timer interrupt event from the
corresponding device.</p></li>

<li><p>any IRQ flow handler <em>from kernel/irq/chip.c</em>. When called from
<code>generic_pipeline_irq()</code> for pushing an external event to the
pipeline, <code>on_pipeline_entry()</code> is true, which indicates that
PIPELINE_MASK is set. When called for playing a deferred interrupt
on the root stage, the virtual interrupt disable bit is set.</p></li>
</ul>

<h3 id="checking-for-out-of-band-interrupt-property">Checking for out-of-band interrupt property</h3>

<p>The <code>IRQF_OOB</code> action flag should <strong>NOT</strong> be used for testing whether
an interrupt is out-of-band, because out-of-band handling may be
turned on/off dynamically on an IRQ descriptor using
<code>irq_switch_oob()</code>, which would not translate to <code>IRQF_OOB</code> being
set/cleared for the attached action handlers.</p>

<p><code>irq_is_oob()</code> is the right way to check for out-of-band handling.</p>

<h3 id="stop-machine-hard-disables-interrupts">stop_machine() hard disables interrupts</h3>

<p>The regular stop_machine() services guarantees that all online CPUs
are spinning non-preemptible in a known code location before a subset
of them may safely run a stop-context function. This service is
typically useful for live patching the kernel code, or changing global
memory mappings, so that no activity could run in parallel until the
system has returned to a stable state after all stop-context
operations have completed.</p>

<p>When interrupt pipelining is enabled, Dovetail provides the same
guarantee by restoring hard interrupt disabling where virtualizing the
interrupt disable flag would defeat it.</p>

<p>As those lines are written, all stop_machine() use cases must also
exclude any head stage activity (e.g. ftrace live patching the kernel
code for installing tracepoints), or happen before any such activity
can ever take place (e.g. KPTI boot mappings). This is a basic
assumption: stop_machine() could not get in the way of
latency-sensitive processes, simply because the latter could not keep
running safely until a call to the former has completed anyway.</p>

<p>However, one should keep an eye on stop_machine() upstream,
identifying new callers which might cause unwanted latency spots under
specific circumstances (maybe even abusing the interface).</p>

<h2 id="arm">ARM</h2>

<h3 id="context-assumption-with-outer-l2-cache">Context assumption with outer L2 cache</h3>

<p>There is no reason for the outer cache to be
invalidated/flushed/cleaned from an out-of-band context, all cache
maintenance operations must happen from in-band code. Therefore, we
neither need nor want to convert the spinlock serializing access to
the cache maintenance operations for L2 to a hard lock.</p>

<div class="notices tip" ><p>Conversion to hard lock may have cause latency to skyrocket on some
i.MX6 hardware, equipped with PL22x cache units, or PL31x with errata
588369 or 727915 for particular hardware revisions, as each background
operation was awaited for completion for working around some silicon
bug, with hard irqs disabled.</p>
</div>



<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/pipeline/porting/misc/" title="Misc"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/pipeline/usage/" title="Usage" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1532619714"></script>
    <script src="/js/perfect-scrollbar.min.js?1532619714"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1532619714"></script>
    <script src="/js/jquery.sticky.js?1532619714"></script>
    <script src="/js/featherlight.min.js?1532619714"></script>
    <script src="/js/html5shiv-printshiv.min.js?1532619714"></script>
    <script src="/js/highlight.pack.js?1532619714"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1532619714"></script>
    <script src="/js/learn.js?1532619714"></script>
    <script src="/js/hugo-learn.js?1532619714"></script>

    <link href="/mermaid/mermaid.css?1532619714" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1532619714"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

