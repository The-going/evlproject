---
menuTitle: "Уставки времени выполнения"
title: "Конфигурация времени выполнения"
weight: 3
original_hash: 1e166ad
---

### Калибровка основного таймера {#calibrate-core-timer}

При включении в ядре EVL прозрачно управляет аппаратным чипом таймера через
[прокси-устройство]({{< relref "dovetail/porting/timer.md" >}}),
обслуживающего все запросы синхронизации, включая запросы, исходящие из
внутриполосной логики ядра. Чтобы максимально повысить точность синхронизации,
EVL необходимо определить базовую задержку целевой платформы.

После получения прерывания, время которое тратится на прохождение кода ядра от
кода ввода низкого уровня до вызова обработчика прерываний, установленного каким-либо
драйвером, меньше, чем время, которое потребовалось бы для возобновления потока
ядра при таком событии. Для возобновления потока пользовательского пространства
потребуется еще больше времени, поскольку это может повлечь за собой изменение
текущего адресного пространства памяти, что может повлечь за собой трудоемкие
операции, связанные с MMU, влияющие на кэш ЦПУ.

Эта базовая задержка может быть увеличена несколькими факторами, такими как:

- задержка кэша шины или процессора,
- задержка, необходимая для программирования микросхемы таймера для следующего выстрела,
- код, выполняемый с отключенными прерываниями на процессоре для получения IRQ,
- межпроцессорная сериализация в ядре EVL (_hard spinlocks_).

Чтобы доставить события как можно ближе к идеальному времени, EVL определяет
понятие _clock gravity_, которое представляет собой набор статических значений
регулировки для учета базовой задержки целевой системы для реагирования на
события таймера с любого данного тактового устройства, как это воспринимается
клиентским кодом, ожидающим этих событий пробуждения. По этой причине
гравитация часов (clock gravity) определяется как триплет значений, который
указывает время, в течение которого следует ожидать каждого выстрела таймера,
в зависимости от целевого контекста, который он должен активировать,
обработчика IRQ, ядра или пользовательского потока.

При запуске с опцией `-t` команда `latmus` выполняет серию тестов для определения
наилучших значений калибровки для таймера ядра EVL, а затем сообщает ядру,
чтобы оно их использовало.

Типичный вывод этой команды выглядит следующим образом:

> Полная калибровка основного таймера
```sh
# latmus -t
== latmus started for core tuning, period=1000 us (may take a while)
irq gravity...2000 ns
kernel gravity...5000 ns
user gravity...6500 ns
== tuning completed after 34s
```

Возможно, вам захочется ограничить процесс калибровки определенным контекстом
(контекстами), и в этом случае вам следует передать соответствующие модификаторы
контекста команде `latmus`, такие как `-u` для пользовательского пространства и
`-i` для задержки IRQ соответственно:

> Калибровка в зависимости от контекста
```sh
# latmus -tui
== latmus started for core tuning, period=1000 us (may take a while)
irq gravity...1000 ns
user gravity...6000 ns
== tuning completed after 21s
```

{{% notice note %}}
Вы можете получить триплеты 'гравитации', отличающиеся от нескольких микросекунд
между запусками одного и того же процесса калибровки: это нормально, и не о чем
беспокоиться, если все эти значения выглядят достаточно близко к ожидаемому
дрожанию в целевой системе. Причина таких расхождений заключается в том, что,
хотя _latmus_ выполняет одни и те же тесты снова и снова, условия в целевой
системе могут отличаться между запусками, что приводит к незначительным изменениям
результатов (например, изменения производительности кэша процессора для цикла
калибровки).
{{% /notice %}}

---

{{<lastmodified>}}
